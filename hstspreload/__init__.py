"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.4.26"
__checksum__ = "0a8db65d71361a440d5eb2c274cdd6ed391d2e7ced112bc4a35fdd8c98aea0cd"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 46), (1385, 14), (1399, 14), (1413, 20), None, (1433, 10), (1443, 13), (1456, 15), (1471, 19), None, (1490, 13), (1503, 19), (1522, 11), (1533, 4), (1537, 22), (1559, 10), (1569, 7), (1576, 14), (1590, 21), (1611, 11), (1622, 21), (1643, 12), (1655, 32), None, (1687, 10), (1697, 14), (1711, 12), (1723, 45), (1768, 15), None, (1783, 11), (1794, 23), (1817, 21), (1838, 26), (1864, 6), (1870, 6), (1876, 7), (1883, 5), (1888, 20), (1908, 23), (1931, 24), (1955, 13), (1968, 15), (1983, 19), (2002, 6), (2008, 61), (2069, 44), (2113, 12), (2125, 23), (2148, 16), (2164, 38), (2202, 6), (2208, 12), (2220, 44), (2264, 6), (2270, 41), (2311, 13), (2324, 23), (2347, 30), (2377, 16), (2393, 8), (2401, 15), (2416, 12), (2428, 19), (2447, 21), (2468, 15), None, (2483, 35), (2518, 21), (2539, 17), (2556, 19), (2575, 26), (2601, 5), (2606, 37), (2643, 26), (2669, 16), (2685, 10), (2695, 17), (2712, 23), (2735, 14), (2749, 17), (2766, 8), (2774, 4), (2778, 7), (2785, 29), (2814, 6), (2820, 18), (2838, 27), (2865, 20), (2885, 17), (2902, 19), (2921, 12), (2933, 40), (2973, 40), (3013, 12), (3025, 48), (3073, 25), (3098, 12), None, (3110, 8), (3118, 25), (3143, 19), (3162, 6), (3168, 23), None, (3191, 30), (3221, 33), (3254, 14), (3268, 12), (3280, 27), None, (3307, 26), (3333, 41), (3374, 50), (3424, 15), (3439, 20), (3459, 15), (3474, 21), (3495, 32), (3527, 24), (3551, 20), (3571, 17), (3588, 60), (3648, 19), (3667, 9), (3676, 12), (3688, 12), (3700, 11), (3711, 10), (3721, 48), (3769, 32), None, (3801, 25), (3826, 23), None, (3849, 8), (3857, 8), (3865, 7), None, (3872, 25), (3897, 17), None, (3914, 21), (3935, 35), (3970, 21), (3991, 10), (4001, 36), (4037, 20), (4057, 22), (4079, 23), (4102, 19), (4121, 12), (4133, 5), (4138, 30), (4168, 24), (4192, 14), (4206, 14), (4220, 47), (4267, 46), None, None, (4313, 51), (4364, 42), None, (4406, 14), None, (4420, 15), (4435, 8), (4443, 21), (4464, 6), (4470, 16), (4486, 17)], [(4503, 7646), (12149, 8118), (20267, 8493), (28760, 7331), (36091, 7709), (43800, 7254), (51054, 8299), (59353, 7197), (66550, 8292), (74842, 7548), (82390, 8898), (91288, 7479), (98767, 8014), (106781, 9330), (116111, 7820), (123931, 7940), (131871, 8416), (140287, 7326), (147613, 7755), (155368, 7510), (162878, 8226), (171104, 7975), (179079, 8339), (187418, 7424), (194842, 7973), (202815, 7847), (210662, 8248), (218910, 8423), (227333, 7612), (234945, 7849), (242794, 8282), (251076, 7799), (258875, 7837), (266712, 8262), (274974, 7367), (282341, 7935), (290276, 7851), (298127, 8532), (306659, 8038), (314697, 8261), (322958, 8871), (331829, 7524), (339353, 7649), (347002, 7521), (354523, 7704), (362227, 7685), (369912, 7879), (377791, 8670), (386461, 7745), (394206, 7210), (401416, 7746), (409162, 8228), (417390, 8281), (425671, 8204), (433875, 8388), (442263, 7943), (450206, 8354), (458560, 7870), (466430, 8407), (474837, 6910), (481747, 7945), (489692, 8021), (497713, 7864), (505577, 8343), (513920, 8180), (522100, 8386), (530486, 7626), (538112, 8520), (546632, 8361), (554993, 8129), (563122, 7764), (570886, 7643), (578529, 7260), (585789, 8371), (594160, 8222), (602382, 8511), (610893, 7445), (618338, 8491), (626829, 8337), (635166, 7592), (642758, 8324), (651082, 6936), (658018, 7923), (665941, 8099), (674040, 7680), (681720, 7874), (689594, 8312), (697906, 8008), (705914, 8264), (714178, 8135), (722313, 8894), (731207, 7281), (738488, 7815), (746303, 7911), (754214, 8164), (762378, 8518), (770896, 8499), (779395, 7662), (787057, 7808), (794865, 7626), (802491, 7635), (810126, 8026), (818152, 7809), (825961, 7804), (833765, 7563), (841328, 8409), (849737, 8293), (858030, 8413), (866443, 9174), (875617, 8437), (884054, 8048), (892102, 8244), (900346, 7777), (908123, 7787), (915910, 8138), (924048, 8324), (932372, 7806), (940178, 7545), (947723, 7775), (955498, 8657), (964155, 8331), (972486, 8385), (980871, 8126), (988997, 8361), (997358, 9194), (1006552, 7819), (1014371, 7221), (1021592, 8474), (1030066, 7986), (1038052, 9727), (1047779, 8641), (1056420, 7577), (1063997, 8206), (1072203, 8029), (1080232, 7641), (1087873, 8308), (1096181, 7725), (1103906, 8357), (1112263, 7733), (1119996, 8065), (1128061, 8057), (1136118, 8393), (1144511, 7431), (1151942, 7688), (1159630, 8089), (1167719, 7738), (1175457, 7771), (1183228, 7897), (1191125, 7569), (1198694, 8403), (1207097, 8134), (1215231, 8235), (1223466, 8358), (1231824, 7727), (1239551, 8067), (1247618, 8076), (1255694, 7928), (1263622, 8043), (1271665, 7568), (1279233, 7208), (1286441, 7430), (1293871, 8244), (1302115, 8598), (1310713, 7730), (1318443, 7651), (1326094, 8647), (1334741, 7801), (1342542, 7414), (1349956, 8445), (1358401, 8073), (1366474, 6983), (1373457, 7906), (1381363, 9288), (1390651, 7341), (1397992, 7577), (1405569, 8290), (1413859, 7804), (1421663, 8205), (1429868, 7745), (1437613, 7419), (1445032, 8894), (1453926, 8351), (1462277, 7725), (1470002, 8427), (1478429, 8942), (1487371, 8721), (1496092, 7342), (1503434, 8392), (1511826, 7743), (1519569, 7983), (1527552, 8464), (1536016, 7704), (1543720, 8311), (1552031, 8283), (1560314, 7925), (1568239, 7921), (1576160, 7754), (1583914, 7937), (1591851, 7910), (1599761, 7654), (1607415, 8279), (1615694, 7590), (1623284, 8472), (1631756, 8052), (1639808, 8517), (1648325, 8356), (1656681, 7128), (1663809, 8209), (1672018, 7835), (1679853, 8129), (1687982, 8168), (1696150, 8291), (1704441, 8093), (1712534, 8381), (1720915, 8240), (1729155, 7797), (1736952, 8050), (1745002, 7784), (1752786, 8179), (1760965, 8312), (1769277, 8093), (1777370, 7387), (1784757, 8919), (1793676, 7973), (1801649, 7767), (1809416, 7896), (1817312, 7981), (1825293, 7403), (1832696, 8268), (1840964, 8058), (1849022, 8679), (1857701, 8128), (1865829, 7655), (1873484, 8335), (1881819, 7905), (1889724, 8794), (1898518, 7684), (1906202, 7682), (1913884, 7037), (1920921, 8335), (1929256, 8111), (1937367, 8421), (1945788, 7777), (1953565, 8173), (1961738, 7736), (1969474, 8454), (1977928, 7776), (1985704, 7313), (1993017, 7803), (2000820, 7543), (2008363, 8187), (2016550, 8590), (2025140, 8411), (2033551, 7625), (2041176, 7739), (2048915, 8054)], [(2056969, 933), (2057902, 715), (2058617, 754), (2059371, 941), (2060312, 638), (2060950, 785), (2061735, 671), (2062406, 987), (2063393, 721), (2064114, 729), (2064843, 641), (2065484, 660), (2066144, 827), (2066971, 885), (2067856, 1043), (2068899, 924), (2069823, 1363), (2071186, 736), (2071922, 987), (2072909, 836), (2073745, 779), (2074524, 864), (2075388, 984), (2076372, 765), (2077137, 778), (2077915, 715), (2078630, 1063), (2079693, 1279), (2080972, 797), (2081769, 853), (2082622, 1037), (2083659, 892), (2084551, 673), (2085224, 806), (2086030, 892), (2086922, 888), (2087810, 822), (2088632, 799), (2089431, 777), (2090208, 1087), (2091295, 726), (2092021, 893), (2092914, 816), (2093730, 784), (2094514, 803), (2095317, 544), (2095861, 1086), (2096947, 1027), (2097974, 867), (2098841, 619), (2099460, 882), (2100342, 734), (2101076, 762), (2101838, 1065), (2102903, 1094), (2103997, 572), (2104569, 729), (2105298, 697), (2105995, 702), (2106697, 903), (2107600, 850), (2108450, 832), (2109282, 1118), (2110400, 1038), (2111438, 793), (2112231, 793), (2113024, 774), (2113798, 511), (2114309, 696), (2115005, 625), (2115630, 803), (2116433, 1001), (2117434, 689), (2118123, 880), (2119003, 664), (2119667, 786), (2120453, 705), (2121158, 738), (2121896, 843), (2122739, 571), (2123310, 875), (2124185, 724), (2124909, 942), (2125851, 679), (2126530, 739), (2127269, 496), (2127765, 712), (2128477, 817), (2129294, 929), (2130223, 847), (2131070, 1050), (2132120, 1220), (2133340, 919), (2134259, 941), (2135200, 817), (2136017, 489), (2136506, 996), (2137502, 871), (2138373, 675), (2139048, 721), (2139769, 800), (2140569, 957), (2141526, 966), (2142492, 619), (2143111, 652), (2143763, 913), (2144676, 533), (2145209, 554), (2145763, 1018), (2146781, 1032), (2147813, 802), (2148615, 836), (2149451, 803), (2150254, 780), (2151034, 767), (2151801, 797), (2152598, 718), (2153316, 597), (2153913, 787), (2154700, 728), (2155428, 1115), (2156543, 772), (2157315, 871), (2158186, 532), (2158718, 741), (2159459, 882), (2160341, 880), (2161221, 1048), (2162269, 767), (2163036, 1032), (2164068, 896), (2164964, 650), (2165614, 939), (2166553, 712), (2167265, 930), (2168195, 795), (2168990, 753), (2169743, 711), (2170454, 781), (2171235, 692), (2171927, 747), (2172674, 713), (2173387, 824), (2174211, 651), (2174862, 545), (2175407, 620), (2176027, 750), (2176777, 668), (2177445, 790), (2178235, 678), (2178913, 823), (2179736, 601), (2180337, 638), (2180975, 852), (2181827, 741), (2182568, 713), (2183281, 784), (2184065, 1064), (2185129, 773), (2185902, 686), (2186588, 1044), (2187632, 922), (2188554, 700), (2189254, 777), (2190031, 967), (2190998, 736), (2191734, 745), (2192479, 686), (2193165, 787), (2193952, 769), (2194721, 882), (2195603, 677), (2196280, 950), (2197230, 832), (2198062, 904), (2198966, 847), (2199813, 737), (2200550, 630), (2201180, 792), (2201972, 840), (2202812, 1552), (2204364, 594), (2204958, 823), (2205781, 731), (2206512, 1025), (2207537, 913), (2208450, 870), (2209320, 653), (2209973, 674), (2210647, 925), (2211572, 638), (2212210, 603), (2212813, 887), (2213700, 800), (2214500, 948), (2215448, 868), (2216316, 810), (2217126, 781), (2217907, 915), (2218822, 731), (2219553, 965), (2220518, 737), (2221255, 879), (2222134, 640), (2222774, 846), (2223620, 641), (2224261, 946), (2225207, 936), (2226143, 772), (2226915, 1036), (2227951, 780), (2228731, 906), (2229637, 999), (2230636, 1146), (2231782, 973), (2232755, 788), (2233543, 1020), (2234563, 810), (2235373, 589), (2235962, 477), (2236439, 865), (2237304, 794), (2238098, 589), (2238687, 1102), (2239789, 594), (2240383, 819), (2241202, 943), (2242145, 949), (2243094, 908), (2244002, 746), (2244748, 933), (2245681, 763), (2246444, 930), (2247374, 619), (2247993, 700), (2248693, 579), (2249272, 698), (2249970, 486), (2250456, 878), (2251334, 962), (2252296, 899), (2253195, 751), (2253946, 688), (2254634, 696), (2255330, 1010), (2256340, 578), (2256918, 625), (2257543, 982), (2258525, 519), (2259044, 976), (2260020, 2165), (2262185, 727), (2262912, 767), (2263679, 975), (2264654, 1094), (2265748, 515)], [(2266263, 48), None, (2266311, 35), (2266346, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2266388, 42), None, (2266430, 25), (2266455, 44), (2266499, 22), (2266521, 18), None, None, None, None, (2266539, 26), None, None, None, None, (2266565, 21), (2266586, 25), None, None, (2266611, 26), None, None, None, None, (2266637, 71), (2266708, 21), (2266729, 23), None, None, None, None, (2266752, 48), None, None, None, None, None, (2266800, 31), None, None, None, None, (2266831, 42), None, (2266873, 22), None, (2266895, 21), None, (2266916, 26), (2266942, 42), None, None, (2266984, 77), None, None, None, None, None, (2267061, 21), (2267082, 21), None, None, (2267103, 34), (2267137, 42), None, None, None, (2267179, 25), None, None, (2267204, 21), None, None, None, None, None, (2267225, 24), (2267249, 21), None, None, (2267270, 26), None, (2267296, 18), None, (2267314, 54), None, None, None, None, None, None, (2267368, 26), None, None, None, (2267394, 20), None, None, (2267414, 42), (2267456, 42), (2267498, 17), (2267515, 17), (2267532, 26), None, (2267558, 26), None, None, None, (2267584, 26), (2267610, 20), (2267630, 26), None, (2267656, 42), (2267698, 63), None, None, None, (2267761, 40), (2267801, 48), None, None, None, (2267849, 47), None, None, None, None, None, None, None, (2267896, 42), None, (2267938, 80), None, (2268018, 9), None, (2268027, 21), (2268048, 42), None, None, (2268090, 65), (2268155, 82), None, None, (2268237, 42), None, None, None, (2268279, 21), None, None, None, None, None, (2268300, 42), (2268342, 21), (2268363, 21), None, (2268384, 42), (2268426, 25), None, (2268451, 16), (2268467, 21), (2268488, 56), None, None, (2268544, 21), (2268565, 19), (2268584, 26), None, (2268610, 16), None, (2268626, 21), None, None, (2268647, 38), None, (2268685, 22), (2268707, 21), (2268728, 21), (2268749, 21), None, (2268770, 63), None, (2268833, 21), (2268854, 42), None, (2268896, 17), None, None, None, None, (2268913, 21), (2268934, 21), None, None, (2268955, 21), None, None, (2268976, 21), None, (2268997, 26), None, (2269023, 50), None, None, None, (2269073, 50), (2269123, 26), (2269149, 21), (2269170, 21), (2269191, 19), None, (2269210, 35), (2269245, 26), (2269271, 23), (2269294, 39), (2269333, 42), None, None, None, None, None, None, (2269375, 21), None, None, None, (2269396, 21), None, None, (2269417, 90), None, (2269507, 239), (2269746, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
