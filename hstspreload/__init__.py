"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.5.31"
__checksum__ = "a1f3d020460a0e7df203b75daae8ce7d106f73c9f6f61f740b92f6e012e408c5"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 59), (1398, 14), (1412, 14), (1426, 20), None, (1446, 10), (1456, 13), (1469, 15), (1484, 19), None, (1503, 13), (1516, 19), (1535, 11), (1546, 4), (1550, 22), (1572, 10), (1582, 7), (1589, 14), (1603, 21), (1624, 11), (1635, 21), (1656, 12), (1668, 32), None, (1700, 10), (1710, 14), (1724, 12), (1736, 45), (1781, 15), None, (1796, 11), (1807, 23), (1830, 21), (1851, 26), (1877, 6), (1883, 6), (1889, 7), (1896, 5), (1901, 20), (1921, 23), (1944, 24), (1968, 13), (1981, 15), (1996, 19), (2015, 6), (2021, 61), (2082, 44), (2126, 12), (2138, 23), (2161, 16), (2177, 38), (2215, 6), (2221, 12), (2233, 44), (2277, 6), (2283, 41), (2324, 13), (2337, 23), (2360, 30), (2390, 16), (2406, 8), (2414, 15), (2429, 12), (2441, 19), (2460, 21), (2481, 15), None, (2496, 35), (2531, 21), (2552, 17), (2569, 19), (2588, 26), (2614, 5), (2619, 37), (2656, 26), (2682, 16), (2698, 10), (2708, 17), (2725, 23), (2748, 14), (2762, 17), (2779, 8), (2787, 8), (2795, 7), (2802, 29), (2831, 6), (2837, 18), (2855, 27), (2882, 20), (2902, 17), (2919, 19), (2938, 12), (2950, 40), (2990, 40), (3030, 12), (3042, 48), (3090, 25), (3115, 12), None, (3127, 8), (3135, 25), (3160, 19), (3179, 6), (3185, 23), None, (3208, 30), (3238, 33), (3271, 14), (3285, 12), (3297, 27), None, (3324, 26), (3350, 41), (3391, 50), (3441, 15), (3456, 20), (3476, 15), (3491, 21), (3512, 32), (3544, 24), (3568, 20), (3588, 17), (3605, 60), (3665, 19), (3684, 9), (3693, 12), (3705, 12), (3717, 11), (3728, 10), (3738, 48), (3786, 32), None, (3818, 25), (3843, 23), None, (3866, 8), (3874, 8), (3882, 7), None, (3889, 25), (3914, 17), None, (3931, 21), (3952, 35), (3987, 21), (4008, 10), (4018, 36), (4054, 20), (4074, 22), (4096, 23), (4119, 19), (4138, 12), (4150, 5), (4155, 30), (4185, 24), (4209, 14), (4223, 14), (4237, 47), (4284, 52), None, None, (4336, 51), (4387, 42), None, (4429, 14), None, (4443, 15), (4458, 8), (4466, 21), (4487, 6), (4493, 16), (4509, 17)], [(4526, 7968), (12494, 8486), (20980, 8826), (29806, 7560), (37366, 7984), (45350, 7875), (53225, 8728), (61953, 7645), (69598, 8585), (78183, 7835), (86018, 9225), (95243, 7744), (102987, 8426), (111413, 9606), (121019, 8119), (129138, 8405), (137543, 8784), (146327, 7790), (154117, 8100), (162217, 7754), (169971, 8619), (178590, 8251), (186841, 8589), (195430, 7951), (203381, 8433), (211814, 8064), (219878, 8542), (228420, 8820), (237240, 7885), (245125, 8259), (253384, 8528), (261912, 8051), (269963, 8243), (278206, 8564), (286770, 7582), (294352, 8353), (302705, 8184), (310889, 8852), (319741, 8500), (328241, 8587), (336828, 9119), (345947, 7841), (353788, 7929), (361717, 7892), (369609, 7991), (377600, 8102), (385702, 8225), (393927, 8989), (402916, 8064), (410980, 7672), (418652, 8089), (426741, 8472), (435213, 8652), (443865, 8492), (452357, 8672), (461029, 8220), (469249, 8568), (477817, 8227), (486044, 8628), (494672, 7231), (501903, 8209), (510112, 8330), (518442, 8221), (526663, 8639), (535302, 8462), (543764, 8649), (552413, 7977), (560390, 8923), (569313, 8731), (578044, 8431), (586475, 8178), (594653, 7925), (602578, 7481), (610059, 8621), (618680, 8430), (627110, 8914), (636024, 7684), (643708, 8805), (652513, 8661), (661174, 7824), (668998, 8681), (677679, 7084), (684763, 8166), (692929, 8639), (701568, 7941), (709509, 8347), (717856, 8817), (726673, 8284), (734957, 8531), (743488, 8479), (751967, 9279), (761246, 7682), (768928, 8102), (777030, 8182), (785212, 8249), (793461, 8883), (802344, 8695), (811039, 7916), (818955, 8015), (826970, 7835), (834805, 7867), (842672, 8314), (850986, 8091), (859077, 8050), (867127, 7817), (874944, 8814), (883758, 8755), (892513, 8717), (901230, 9467), (910697, 8644), (919341, 8442), (927783, 8535), (936318, 8204), (944522, 8142), (952664, 8518), (961182, 8616), (969798, 8248), (978046, 7959), (986005, 8014), (994019, 8967), (1002986, 8725), (1011711, 8722), (1020433, 8336), (1028769, 8653), (1037422, 9431), (1046853, 8028), (1054881, 7541), (1062422, 8853), (1071275, 8216), (1079491, 9981), (1089472, 8827), (1098299, 7893), (1106192, 8562), (1114754, 8335), (1123089, 8051), (1131140, 8467), (1139607, 7967), (1147574, 8801), (1156375, 8036), (1164411, 8299), (1172710, 8351), (1181061, 8589), (1189650, 7673), (1197323, 8069), (1205392, 8338), (1213730, 8026), (1221756, 8174), (1229930, 8242), (1238172, 7981), (1246153, 8715), (1254868, 8511), (1263379, 8458), (1271837, 8752), (1280589, 8074), (1288663, 8301), (1296964, 8473), (1305437, 8142), (1313579, 8260), (1321839, 7936), (1329775, 7396), (1337171, 7689), (1344860, 8581), (1353441, 8912), (1362353, 8078), (1370431, 8121), (1378552, 8964), (1387516, 8141), (1395657, 7853), (1403510, 8740), (1412250, 8265), (1420515, 7301), (1427816, 8289), (1436105, 9672), (1445777, 7737), (1453514, 7841), (1461355, 8618), (1469973, 8216), (1478189, 8658), (1486847, 8049), (1494896, 7766), (1502662, 9196), (1511858, 8667), (1520525, 8099), (1528624, 8585), (1537209, 9202), (1546411, 9116), (1555527, 7716), (1563243, 8563), (1571806, 7929), (1579735, 8316), (1588051, 8995), (1597046, 8032), (1605078, 8577), (1613655, 8466), (1622121, 8229), (1630350, 8268), (1638618, 7989), (1646607, 8165), (1654772, 8330), (1663102, 7961), (1671063, 8528), (1679591, 7869), (1687460, 8749), (1696209, 8344), (1704553, 8892), (1713445, 8698), (1722143, 7483), (1729626, 8754), (1738380, 8114), (1746494, 8508), (1755002, 8545), (1763547, 8691), (1772238, 8276), (1780514, 8600), (1789114, 8478), (1797592, 8146), (1805738, 8350), (1814088, 8066), (1822154, 8404), (1830558, 8609), (1839167, 8415), (1847582, 7669), (1855251, 9302), (1864553, 8210), (1872763, 8209), (1880972, 8238), (1889210, 8227), (1897437, 7741), (1905178, 8590), (1913768, 8412), (1922180, 8932), (1931112, 8310), (1939422, 7909), (1947331, 8871), (1956202, 8226), (1964428, 9161), (1973589, 7894), (1981483, 8036), (1989519, 7399), (1996918, 8629), (2005547, 8627), (2014174, 8877), (2023051, 8082), (2031133, 8433), (2039566, 8090), (2047656, 8797), (2056453, 7992), (2064445, 7721), (2072166, 8210), (2080376, 7836), (2088212, 8517), (2096729, 8804), (2105533, 8737), (2114270, 7976), (2122246, 8237), (2130483, 8388)], [(2138871, 933), (2139804, 715), (2140519, 772), (2141291, 960), (2142251, 660), (2142911, 838), (2143749, 671), (2144420, 1000), (2145420, 704), (2146124, 758), (2146882, 641), (2147523, 677), (2148200, 827), (2149027, 872), (2149899, 1067), (2150966, 973), (2151939, 1363), (2153302, 736), (2154038, 1008), (2155046, 855), (2155901, 779), (2156680, 879), (2157559, 1000), (2158559, 773), (2159332, 811), (2160143, 733), (2160876, 1077), (2161953, 1312), (2163265, 832), (2164097, 853), (2164950, 1075), (2166025, 892), (2166917, 697), (2167614, 842), (2168456, 981), (2169437, 934), (2170371, 847), (2171218, 874), (2172092, 832), (2172924, 1160), (2174084, 726), (2174810, 927), (2175737, 783), (2176520, 784), (2177304, 803), (2178107, 561), (2178668, 1086), (2179754, 1027), (2180781, 889), (2181670, 619), (2182289, 897), (2183186, 734), (2183920, 812), (2184732, 1092), (2185824, 1094), (2186918, 572), (2187490, 767), (2188257, 697), (2188954, 728), (2189682, 892), (2190574, 917), (2191491, 859), (2192350, 1133), (2193483, 1078), (2194561, 835), (2195396, 788), (2196184, 809), (2196993, 511), (2197504, 696), (2198200, 625), (2198825, 826), (2199651, 1001), (2200652, 689), (2201341, 880), (2202221, 700), (2202921, 797), (2203718, 705), (2204423, 754), (2205177, 843), (2206020, 571), (2206591, 892), (2207483, 724), (2208207, 991), (2209198, 714), (2209912, 791), (2210703, 548), (2211251, 761), (2212012, 859), (2212871, 943), (2213814, 875), (2214689, 1092), (2215781, 1262), (2217043, 919), (2217962, 925), (2218887, 842), (2219729, 514), (2220243, 996), (2221239, 887), (2222126, 675), (2222801, 721), (2223522, 848), (2224370, 1042), (2225412, 966), (2226378, 634), (2227012, 652), (2227664, 913), (2228577, 533), (2229110, 589), (2229699, 1018), (2230717, 1032), (2231749, 821), (2232570, 852), (2233422, 803), (2234225, 801), (2235026, 834), (2235860, 823), (2236683, 731), (2237414, 597), (2238011, 801), (2238812, 728), (2239540, 1136), (2240676, 757), (2241433, 889), (2242322, 532), (2242854, 782), (2243636, 882), (2244518, 910), (2245428, 1048), (2246476, 767), (2247243, 1032), (2248275, 925), (2249200, 630), (2249830, 939), (2250769, 787), (2251556, 977), (2252533, 795), (2253328, 753), (2254081, 711), (2254792, 840), (2255632, 706), (2256338, 760), (2257098, 744), (2257842, 824), (2258666, 651), (2259317, 577), (2259894, 637), (2260531, 750), (2261281, 668), (2261949, 824), (2262773, 718), (2263491, 815), (2264306, 617), (2264923, 638), (2265561, 893), (2266454, 764), (2267218, 713), (2267931, 797), (2268728, 1058), (2269786, 805), (2270591, 664), (2271255, 1069), (2272324, 922), (2273246, 720), (2273966, 826), (2274792, 993), (2275785, 736), (2276521, 745), (2277266, 706), (2277972, 756), (2278728, 799), (2279527, 882), (2280409, 677), (2281086, 993), (2282079, 832), (2282911, 920), (2283831, 911), (2284742, 759), (2285501, 630), (2286131, 792), (2286923, 854), (2287777, 1576), (2289353, 610), (2289963, 843), (2290806, 731), (2291537, 1068), (2292605, 913), (2293518, 846), (2294364, 666), (2295030, 674), (2295704, 939), (2296643, 638), (2297281, 611), (2297892, 887), (2298779, 800), (2299579, 964), (2300543, 854), (2301397, 810), (2302207, 763), (2302970, 908), (2303878, 750), (2304628, 961), (2305589, 757), (2306346, 879), (2307225, 688), (2307913, 846), (2308759, 662), (2309421, 981), (2310402, 954), (2311356, 783), (2312139, 1036), (2313175, 780), (2313955, 919), (2314874, 975), (2315849, 1146), (2316995, 957), (2317952, 830), (2318782, 1006), (2319788, 810), (2320598, 615), (2321213, 490), (2321703, 908), (2322611, 827), (2323438, 589), (2324027, 1117), (2325144, 594), (2325738, 824), (2326562, 987), (2327549, 972), (2328521, 925), (2329446, 746), (2330192, 962), (2331154, 797), (2331951, 949), (2332900, 674), (2333574, 700), (2334274, 619), (2334893, 698), (2335591, 486), (2336077, 900), (2336977, 1038), (2338015, 926), (2338941, 751), (2339692, 688), (2340380, 696), (2341076, 1046), (2342122, 616), (2342738, 625), (2343363, 982), (2344345, 519), (2344864, 990), (2345854, 2180), (2348034, 727), (2348761, 767), (2349528, 975), (2350503, 1138), (2351641, 515)], [(2352156, 48), None, (2352204, 35), (2352239, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2352281, 42), None, (2352323, 25), (2352348, 44), (2352392, 22), (2352414, 18), None, None, None, None, (2352432, 26), None, None, None, None, (2352458, 21), (2352479, 25), None, None, (2352504, 26), None, None, None, None, (2352530, 71), (2352601, 21), (2352622, 23), None, None, None, None, (2352645, 48), None, None, None, None, None, (2352693, 31), None, None, None, None, (2352724, 42), None, (2352766, 22), None, (2352788, 21), None, (2352809, 26), (2352835, 42), None, None, (2352877, 77), (2352954, 27), None, None, None, None, (2352981, 21), (2353002, 21), None, None, (2353023, 34), (2353057, 42), None, None, None, (2353099, 25), None, None, (2353124, 21), None, None, None, None, None, (2353145, 24), (2353169, 21), None, None, (2353190, 26), None, (2353216, 18), None, (2353234, 54), None, None, None, None, None, None, (2353288, 26), None, None, None, (2353314, 20), None, None, (2353334, 64), (2353398, 42), (2353440, 17), (2353457, 17), (2353474, 26), None, (2353500, 26), None, None, None, (2353526, 26), (2353552, 20), (2353572, 26), None, (2353598, 42), (2353640, 63), None, None, None, (2353703, 40), (2353743, 48), None, None, None, (2353791, 47), None, None, None, None, None, None, None, (2353838, 42), None, (2353880, 80), None, (2353960, 9), None, (2353969, 21), (2353990, 42), None, None, (2354032, 65), (2354097, 82), None, None, (2354179, 42), None, None, (2354221, 24), (2354245, 21), None, None, None, None, None, (2354266, 42), (2354308, 21), (2354329, 21), None, (2354350, 42), (2354392, 25), None, (2354417, 38), (2354455, 21), (2354476, 56), None, None, (2354532, 21), (2354553, 19), (2354572, 26), None, (2354598, 16), None, (2354614, 21), None, None, (2354635, 38), None, (2354673, 22), (2354695, 21), (2354716, 21), (2354737, 21), None, (2354758, 63), None, (2354821, 21), (2354842, 42), None, (2354884, 17), None, None, None, None, (2354901, 21), (2354922, 21), None, None, (2354943, 21), None, None, (2354964, 21), None, (2354985, 26), None, (2355011, 50), None, None, None, (2355061, 50), (2355111, 26), (2355137, 21), (2355158, 21), (2355179, 19), None, (2355198, 35), (2355233, 26), (2355259, 23), (2355282, 39), (2355321, 42), None, None, None, None, None, None, (2355363, 21), None, None, None, (2355384, 21), None, None, (2355405, 90), None, (2355495, 239), (2355734, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
