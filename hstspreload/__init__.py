"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.6.14"
__checksum__ = "206b494c861055a1b07c4aec901b14e5e6e7210fea5de620124d75f8e1e4e083"
__all__ = ["in_hsts_preload"]

# fmt: off
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 11), (141, 7), (148, 20), (168, 18), None, (186, 22), (208, 45), (253, 7), (260, 9), (269, 36), (305, 10), (315, 10), (325, 21), None, (346, 50), (396, 8), (404, 9), (413, 11), (424, 13), (437, 14), (451, 14), None, None, (465, 29), (494, 16), (510, 35), (545, 14), (559, 24), (583, 9), None, (592, 17), (609, 20), (629, 8), (637, 13), (650, 10), None, (660, 11), (671, 6), (677, 26), (703, 5), (708, 5), (713, 10), (723, 10), (733, 11), (744, 12), (756, 27), None, (783, 11), (794, 5), (799, 7), (806, 29), (835, 18), (853, 27), (880, 46), (926, 25), (951, 16), (967, 8), (975, 5), (980, 22), (1002, 18), None, (1020, 32), (1052, 15), (1067, 8), (1075, 5), None, (1080, 5), (1085, 16), (1101, 14), (1115, 18), None, (1133, 14), (1147, 18), (1165, 48), (1213, 19), (1232, 5), (1237, 46), (1283, 14), (1297, 14), (1311, 20), None, (1331, 6), (1337, 13), (1350, 10), (1360, 19), None, (1379, 13), (1392, 19), (1411, 5), (1416, 4), (1420, 22), (1442, 10), (1452, 7), (1459, 14), (1473, 21), (1494, 11), (1505, 10), (1515, 12), (1527, 32), None, (1559, 10), (1569, 14), (1583, 12), (1595, 45), (1640, 15), None, (1655, 11), (1666, 23), (1689, 21), (1710, 26), (1736, 6), (1742, 6), (1748, 7), (1755, 5), (1760, 20), (1780, 23), (1803, 24), (1827, 13), (1840, 15), (1855, 19), (1874, 6), (1880, 61), (1941, 44), (1985, 12), (1997, 23), (2020, 16), (2036, 38), (2074, 6), (2080, 12), (2092, 44), (2136, 6), (2142, 41), (2183, 13), (2196, 23), (2219, 30), (2249, 16), (2265, 8), (2273, 6), (2279, 12), (2291, 19), (2310, 21), (2331, 15), None, (2346, 35), (2381, 21), (2402, 17), (2419, 19), (2438, 26), (2464, 5), (2469, 37), (2506, 30), (2536, 16), (2552, 10), (2562, 17), (2579, 23), (2602, 14), (2616, 17), (2633, 8), (2641, 4), (2645, 7), (2652, 29), (2681, 6), (2687, 18), (2705, 27), (2732, 20), (2752, 17), (2769, 19), (2788, 12), (2800, 40), (2840, 40), (2880, 12), (2892, 48), (2940, 25), (2965, 12), None, (2977, 8), (2985, 20), (3005, 12), (3017, 6), (3023, 23), None, (3046, 23), (3069, 33), (3102, 14), (3116, 12), (3128, 27), None, (3155, 26), (3181, 31), (3212, 50), (3262, 15), (3277, 20), (3297, 15), (3312, 21), (3333, 32), (3365, 24), (3389, 20), (3409, 13), (3422, 60), (3482, 19), (3501, 9), (3510, 12), (3522, 12), (3534, 11), (3545, 10), (3555, 48), (3603, 32), None, (3635, 25), (3660, 12), None, (3672, 8), (3680, 8), (3688, 7), None, (3695, 25), (3720, 17), None, (3737, 21), (3758, 35), (3793, 12), (3805, 10), (3815, 36), (3851, 20), (3871, 22), (3893, 23), (3916, 19), (3935, 12), (3947, 5), (3952, 30), (3982, 24), (4006, 14), (4020, 14), (4034, 47), (4081, 38), None, None, (4119, 51), (4170, 42), None, (4212, 14), None, (4226, 15), (4241, 8), (4249, 21), (4270, 6), (4276, 16), (4292, 17)], [(4309, 5966), (10275, 6442), (16717, 6837), (23554, 5556), (29110, 6064), (35174, 5641), (40815, 6495), (47310, 5798), (53108, 6445), (59553, 5803), (65356, 6823), (72179, 6025), (78204, 6490), (84694, 6813), (91507, 6293), (97800, 6237), (104037, 6760), (110797, 5717), (116514, 6037), (122551, 6353), (128904, 6582), (135486, 6250), (141736, 6504), (148240, 5837), (154077, 5956), (160033, 6410), (166443, 6271), (172714, 6597), (179311, 6041), (185352, 6184), (191536, 6455), (197991, 6225), (204216, 6153), (210369, 6745), (217114, 5792), (222906, 6629), (229535, 5975), (235510, 6702), (242212, 6334), (248546, 6752), (255298, 7070), (262368, 6061), (268429, 6073), (274502, 5834), (280336, 5854), (286190, 5733), (291923, 6057), (297980, 6644), (304624, 6171), (310795, 5463), (316258, 6199), (322457, 6330), (328787, 6267), (335054, 6501), (341555, 6541), (348096, 6539), (354635, 6535), (361170, 5554), (366724, 6515), (373239, 5564), (378803, 6181), (384984, 6032), (391016, 6079), (397095, 6530), (403625, 6353), (409978, 6355), (416333, 5728), (422061, 6688), (428749, 6344), (435093, 6449), (441542, 6182), (447724, 6138), (453862, 5509), (459371, 6748), (466119, 6657), (472776, 6643), (479419, 5737), (485156, 6867), (492023, 6823), (498846, 5763), (504609, 6443), (511052, 5458), (516510, 6021), (522531, 6281), (528812, 6204), (535016, 6195), (541211, 6312), (547523, 6401), (553924, 6434), (560358, 6198), (566556, 6929), (573485, 5879), (579364, 5935), (585299, 6326), (591625, 6169), (597794, 6700), (604494, 6450), (610944, 6157), (617101, 6064), (623165, 5904), (629069, 5856), (634925, 6517), (641442, 5929), (647371, 6010), (653381, 5822), (659203, 6536), (665739, 6088), (671827, 6470), (678297, 7752), (686049, 6756), (692805, 6666), (699471, 6126), (705597, 6040), (711637, 6426), (718063, 6605), (724668, 6296), (730964, 6011), (736975, 6224), (743199, 6165), (749364, 6633), (755997, 6552), (762549, 6480), (769029, 6852), (775881, 6462), (782343, 7590), (789933, 6120), (796053, 5399), (801452, 6630), (808082, 6401), (814483, 7708), (822191, 6693), (828884, 5973), (834857, 6385), (841242, 6595), (847837, 6073), (853910, 6448), (860358, 5771), (866129, 6511), (872640, 6088), (878728, 6160), (884888, 6220), (891108, 6847), (897955, 6062), (904017, 5985), (910002, 6296), (916298, 6296), (922594, 6170), (928764, 6561), (935325, 5810), (941135, 6772), (947907, 6314), (954221, 6456), (960677, 6504), (967181, 6223), (973404, 6220), (979624, 6147), (985771, 6154), (991925, 6069), (997994, 5933), (1003927, 5585), (1009512, 5872), (1015384, 6277), (1021661, 6838), (1028499, 5861), (1034360, 6272), (1040632, 6686), (1047318, 6140), (1053458, 5877), (1059335, 6527), (1065862, 6329), (1072191, 5650), (1077841, 6355), (1084196, 7314), (1091510, 5746), (1097256, 5948), (1103204, 6369), (1109573, 5954), (1115527, 6354), (1121881, 6004), (1127885, 5744), (1133629, 7024), (1140653, 6454), (1147107, 6170), (1153277, 6541), (1159818, 7007), (1166825, 6994), (1173819, 5897), (1179716, 6716), (1186432, 6008), (1192440, 6373), (1198813, 6429), (1205242, 5936), (1211178, 6541), (1217719, 6600), (1224319, 6447), (1230766, 6151), (1236917, 6062), (1242979, 6113), (1249092, 6471), (1255563, 5875), (1261438, 6237), (1267675, 5701), (1273376, 6771), (1280147, 6673), (1286820, 6405), (1293225, 6601), (1299826, 5416), (1305242, 6330), (1311572, 6254), (1317826, 6365), (1324191, 6538), (1330729, 6811), (1337540, 6263), (1343803, 6304), (1350107, 6393), (1356500, 6222), (1362722, 6156), (1368878, 6327), (1375205, 6407), (1381612, 6001), (1387613, 6199), (1393812, 5689), (1399501, 6911), (1406412, 6467), (1412879, 6023), (1418902, 6541), (1425443, 6352), (1431795, 5444), (1437239, 6324), (1443563, 6249), (1449812, 7173), (1456985, 6161), (1463146, 5555), (1468701, 6728), (1475429, 6079), (1481508, 6624), (1488132, 5820), (1493952, 5888), (1499840, 5632), (1505472, 6451), (1511923, 6091), (1518014, 6622), (1524636, 5996), (1530632, 6324), (1536956, 6139), (1543095, 6798), (1549893, 6133), (1556026, 5536), (1561562, 6234), (1567796, 6006), (1573802, 6357), (1580159, 6525), (1586684, 6932), (1593616, 5994), (1599610, 5985), (1605595, 6483)], [(1612078, 703), (1612781, 605), (1613386, 605), (1613991, 645), (1614636, 471), (1615107, 579), (1615686, 665), (1616351, 808), (1617159, 652), (1617811, 647), (1618458, 509), (1618967, 508), (1619475, 741), (1620216, 862), (1621078, 885), (1621963, 690), (1622653, 1188), (1623841, 559), (1624400, 804), (1625204, 640), (1625844, 713), (1626557, 688), (1627245, 767), (1628012, 709), (1628721, 684), (1629405, 631), (1630036, 850), (1630886, 983), (1631869, 746), (1632615, 608), (1633223, 902), (1634125, 725), (1634850, 538), (1635388, 671), (1636059, 712), (1636771, 674), (1637445, 602), (1638047, 656), (1638703, 692), (1639395, 929), (1640324, 683), (1641007, 775), (1641782, 660), (1642442, 651), (1643093, 680), (1643773, 362), (1644135, 728), (1644863, 857), (1645720, 673), (1646393, 517), (1646910, 717), (1647627, 617), (1648244, 750), (1648994, 898), (1649892, 837), (1650729, 442), (1651171, 634), (1651805, 486), (1652291, 614), (1652905, 662), (1653567, 716), (1654283, 707), (1654990, 983), (1655973, 773), (1656746, 555), (1657301, 692), (1657993, 735), (1658728, 447), (1659175, 540), (1659715, 429), (1660144, 653), (1660797, 789), (1661586, 521), (1662107, 706), (1662813, 634), (1663447, 660), (1664107, 530), (1664637, 661), (1665298, 752), (1666050, 428), (1666478, 653), (1667131, 607), (1667738, 828), (1668566, 623), (1669189, 588), (1669777, 264), (1670041, 597), (1670638, 691), (1671329, 741), (1672070, 647), (1672717, 781), (1673498, 1071), (1674569, 772), (1675341, 723), (1676064, 661), (1676725, 419), (1677144, 890), (1678034, 835), (1678869, 564), (1679433, 508), (1679941, 666), (1680607, 843), (1681450, 799), (1682249, 522), (1682771, 632), (1683403, 653), (1684056, 363), (1684419, 467), (1684886, 883), (1685769, 802), (1686571, 750), (1687321, 724), (1688045, 566), (1688611, 749), (1689360, 591), (1689951, 667), (1690618, 636), (1691254, 448), (1691702, 657), (1692359, 563), (1692922, 895), (1693817, 643), (1694460, 762), (1695222, 348), (1695570, 681), (1696251, 656), (1696907, 818), (1697725, 854), (1698579, 745), (1699324, 873), (1700197, 715), (1700912, 502), (1701414, 743), (1702157, 583), (1702740, 737), (1703477, 685), (1704162, 564), (1704726, 682), (1705408, 551), (1705959, 613), (1706572, 581), (1707153, 691), (1707844, 652), (1708496, 635), (1709131, 401), (1709532, 526), (1710058, 641), (1710699, 573), (1711272, 668), (1711940, 594), (1712534, 744), (1713278, 520), (1713798, 478), (1714276, 656), (1714932, 583), (1715515, 607), (1716122, 623), (1716745, 774), (1717519, 594), (1718113, 572), (1718685, 872), (1719557, 780), (1720337, 522), (1720859, 660), (1721519, 767), (1722286, 586), (1722872, 649), (1723521, 459), (1723980, 604), (1724584, 597), (1725181, 714), (1725895, 561), (1726456, 865), (1727321, 658), (1727979, 793), (1728772, 643), (1729415, 606), (1730021, 498), (1730519, 614), (1731133, 699), (1731832, 1263), (1733095, 514), (1733609, 641), (1734250, 608), (1734858, 928), (1735786, 730), (1736516, 692), (1737208, 491), (1737699, 565), (1738264, 808), (1739072, 531), (1739603, 554), (1740157, 826), (1740983, 607), (1741590, 848), (1742438, 746), (1743184, 644), (1743828, 646), (1744474, 804), (1745278, 620), (1745898, 850), (1746748, 616), (1747364, 688), (1748052, 534), (1748586, 689), (1749275, 427), (1749702, 734), (1750436, 709), (1751145, 662), (1751807, 865), (1752672, 729), (1753401, 731), (1754132, 838), (1754970, 972), (1755942, 815), (1756757, 586), (1757343, 820), (1758163, 604), (1758767, 483), (1759250, 443), (1759693, 710), (1760403, 760), (1761163, 387), (1761550, 937), (1762487, 443), (1762930, 718), (1763648, 844), (1764492, 650), (1765142, 769), (1765911, 626), (1766537, 700), (1767237, 665), (1767902, 667), (1768569, 546), (1769115, 566), (1769681, 397), (1770078, 568), (1770646, 437), (1771083, 723), (1771806, 795), (1772601, 646), (1773247, 700), (1773947, 621), (1774568, 568), (1775136, 773), (1775909, 406), (1776315, 457), (1776772, 719), (1777491, 467), (1777958, 788), (1778746, 2053), (1780799, 465), (1781264, 602), (1781866, 875), (1782741, 743), (1783484, 491)], [(1783975, 48), None, (1784023, 35), (1784058, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1784100, 42), None, (1784142, 25), (1784167, 16), None, None, None, None, None, None, (1784183, 26), None, None, None, None, (1784209, 21), (1784230, 25), None, None, (1784255, 26), None, None, None, None, (1784281, 44), (1784325, 21), (1784346, 23), None, None, None, None, (1784369, 48), None, None, None, None, None, (1784417, 31), None, None, None, None, (1784448, 42), None, (1784490, 22), None, (1784512, 21), None, (1784533, 26), (1784559, 42), None, None, (1784601, 77), None, None, None, None, None, (1784678, 21), (1784699, 21), None, None, (1784720, 34), (1784754, 42), None, None, None, (1784796, 25), None, None, (1784821, 21), None, None, None, None, None, (1784842, 24), (1784866, 21), None, None, (1784887, 26), None, (1784913, 18), None, (1784931, 54), None, None, None, None, None, None, (1784985, 26), None, (1785011, 19), None, (1785030, 20), None, None, (1785050, 42), (1785092, 42), (1785134, 17), None, (1785151, 26), None, (1785177, 26), None, None, None, (1785203, 26), (1785229, 20), (1785249, 26), None, (1785275, 42), (1785317, 63), None, None, None, (1785380, 40), None, None, None, None, (1785420, 47), None, None, None, None, None, None, None, (1785467, 42), None, (1785509, 55), None, (1785564, 9), None, (1785573, 21), (1785594, 42), None, None, (1785636, 42), (1785678, 82), None, None, (1785760, 42), None, None, None, None, None, None, None, None, None, (1785802, 42), (1785844, 21), (1785865, 21), None, (1785886, 42), (1785928, 25), None, None, (1785953, 21), (1785974, 42), None, None, (1786016, 21), (1786037, 19), (1786056, 26), None, None, None, (1786082, 21), None, None, (1786103, 38), None, (1786141, 22), (1786163, 21), (1786184, 21), None, None, (1786205, 63), None, (1786268, 21), (1786289, 42), None, (1786331, 17), None, None, None, None, (1786348, 21), (1786369, 21), None, None, (1786390, 21), None, None, (1786411, 21), None, (1786432, 26), None, (1786458, 50), None, None, None, (1786508, 50), (1786558, 26), (1786584, 21), (1786605, 21), (1786626, 19), None, (1786645, 35), (1786680, 26), (1786706, 23), (1786729, 21), (1786750, 42), None, None, None, None, None, None, (1786792, 21), None, None, None, (1786813, 21), None, None, (1786834, 90), None, (1786924, 239), (1787163, 38), None, None, None, None]]  # noqa: E501
# fmt: on

# fmt: off
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40
_GTLD_INCLUDE_SUBDOMAINS = {
    b"android",
    b"app",
    b"bank",
    b"chrome",
    b"dev",
    b"foo",
    b"gle",
    b"gmail",
    b"google",
    b"hangout",
    b"insurance",
    b"meet",
    b"new",
    b"page",
    b"play",
    b"search",
    b"youtube",
}

try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
