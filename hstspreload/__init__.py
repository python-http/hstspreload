"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.4.19"
__checksum__ = "4284b66cf6bb0f37d42ebf431218f421474438d32c32f3302d137b12d579919a"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 46), (1385, 14), (1399, 14), (1413, 20), None, (1433, 10), (1443, 13), (1456, 15), (1471, 19), None, (1490, 13), (1503, 19), (1522, 11), (1533, 4), (1537, 22), (1559, 10), (1569, 7), (1576, 14), (1590, 21), (1611, 11), (1622, 21), (1643, 12), (1655, 32), None, (1687, 10), (1697, 14), (1711, 12), (1723, 45), (1768, 15), None, (1783, 11), (1794, 23), (1817, 21), (1838, 26), (1864, 6), (1870, 6), (1876, 7), (1883, 5), (1888, 20), (1908, 23), (1931, 24), (1955, 13), (1968, 15), (1983, 19), (2002, 6), (2008, 61), (2069, 44), (2113, 12), (2125, 23), (2148, 16), (2164, 38), (2202, 6), (2208, 12), (2220, 44), (2264, 6), (2270, 41), (2311, 13), (2324, 23), (2347, 30), (2377, 16), (2393, 8), (2401, 15), (2416, 12), (2428, 19), (2447, 21), (2468, 15), None, (2483, 35), (2518, 21), (2539, 17), (2556, 19), (2575, 26), (2601, 5), (2606, 37), (2643, 26), (2669, 16), (2685, 10), (2695, 17), (2712, 23), (2735, 14), (2749, 17), (2766, 8), (2774, 4), (2778, 7), (2785, 29), (2814, 6), (2820, 18), (2838, 27), (2865, 20), (2885, 17), (2902, 19), (2921, 12), (2933, 40), (2973, 40), (3013, 12), (3025, 48), (3073, 25), (3098, 12), None, (3110, 8), (3118, 25), (3143, 19), (3162, 6), (3168, 23), None, (3191, 30), (3221, 33), (3254, 14), (3268, 12), (3280, 27), None, (3307, 26), (3333, 41), (3374, 50), (3424, 15), (3439, 20), (3459, 15), (3474, 21), (3495, 32), (3527, 24), (3551, 20), (3571, 17), (3588, 60), (3648, 19), (3667, 9), (3676, 12), (3688, 12), (3700, 11), (3711, 10), (3721, 48), (3769, 32), None, (3801, 25), (3826, 23), None, (3849, 8), (3857, 8), (3865, 7), None, (3872, 25), (3897, 17), None, (3914, 21), (3935, 35), (3970, 21), (3991, 10), (4001, 36), (4037, 20), (4057, 22), (4079, 23), (4102, 19), (4121, 12), (4133, 5), (4138, 30), (4168, 24), (4192, 14), (4206, 14), (4220, 47), (4267, 46), None, None, (4313, 51), (4364, 42), None, (4406, 14), None, (4420, 15), (4435, 8), (4443, 21), (4464, 6), (4470, 16), (4486, 17)], [(4503, 7607), (12110, 8117), (20227, 8458), (28685, 7320), (36005, 7707), (43712, 7236), (50948, 8336), (59284, 7189), (66473, 8278), (74751, 7576), (82327, 8861), (91188, 7519), (98707, 8016), (106723, 9236), (115959, 7791), (123750, 7891), (131641, 8400), (140041, 7289), (147330, 7726), (155056, 7473), (162529, 8212), (170741, 7939), (178680, 8339), (187019, 7424), (194443, 7926), (202369, 7799), (210168, 8241), (218409, 8360), (226769, 7588), (234357, 7849), (242206, 8230), (250436, 7754), (258190, 7854), (266044, 8178), (274222, 7367), (281589, 7915), (289504, 7827), (297331, 8532), (305863, 8038), (313901, 8240), (322141, 8847), (330988, 7524), (338512, 7662), (346174, 7481), (353655, 7647), (361302, 7672), (368974, 7906), (376880, 8625), (385505, 7762), (393267, 7210), (400477, 7746), (408223, 8185), (416408, 8190), (424598, 8245), (432843, 8368), (441211, 7931), (449142, 8328), (457470, 7864), (465334, 8419), (473753, 6859), (480612, 7934), (488546, 7986), (496532, 7869), (504401, 8327), (512728, 8150), (520878, 8358), (529236, 7597), (536833, 8538), (545371, 8355), (553726, 8085), (561811, 7710), (569521, 7643), (577164, 7218), (584382, 8354), (592736, 8185), (600921, 8496), (609417, 7426), (616843, 8459), (625302, 8344), (633646, 7576), (641222, 8320), (649542, 6952), (656494, 7921), (664415, 8063), (672478, 7659), (680137, 7825), (687962, 8309), (696271, 8032), (704303, 8234), (712537, 8106), (720643, 8894), (729537, 7261), (736798, 7830), (744628, 7911), (752539, 8133), (760672, 8534), (769206, 8470), (777676, 7645), (785321, 7747), (793068, 7645), (800713, 7686), (808399, 7963), (816362, 7779), (824141, 7749), (831890, 7562), (839452, 8389), (847841, 8292), (856133, 8377), (864510, 9172), (873682, 8435), (882117, 8068), (890185, 8251), (898436, 7749), (906185, 7743), (913928, 8089), (922017, 8287), (930304, 7794), (938098, 7545), (945643, 7791), (953434, 8645), (962079, 8266), (970345, 8335), (978680, 8027), (986707, 8366), (995073, 9194), (1004267, 7819), (1012086, 7232), (1019318, 8488), (1027806, 8000), (1035806, 9677), (1045483, 8555), (1054038, 7575), (1061613, 8165), (1069778, 8001), (1077779, 7608), (1085387, 8291), (1093678, 7679), (1101357, 8309), (1109666, 7715), (1117381, 7979), (1125360, 8031), (1133391, 8386), (1141777, 7431), (1149208, 7687), (1156895, 8041), (1164936, 7714), (1172650, 7755), (1180405, 7848), (1188253, 7522), (1195775, 8428), (1204203, 8099), (1212302, 8226), (1220528, 8345), (1228873, 7669), (1236542, 8033), (1244575, 8062), (1252637, 7861), (1260498, 8006), (1268504, 7591), (1276095, 7187), (1283282, 7420), (1290702, 8230), (1298932, 8547), (1307479, 7716), (1315195, 7657), (1322852, 8647), (1331499, 7767), (1339266, 7382), (1346648, 8426), (1355074, 8065), (1363139, 6983), (1370122, 7895), (1378017, 9267), (1387284, 7326), (1394610, 7560), (1402170, 8243), (1410413, 7773), (1418186, 8184), (1426370, 7743), (1434113, 7419), (1441532, 8894), (1450426, 8327), (1458753, 7725), (1466478, 8400), (1474878, 8930), (1483808, 8659), (1492467, 7358), (1499825, 8376), (1508201, 7753), (1515954, 7962), (1523916, 8424), (1532340, 7704), (1540044, 8311), (1548355, 8304), (1556659, 7864), (1564523, 7897), (1572420, 7674), (1580094, 7937), (1588031, 7851), (1595882, 7650), (1603532, 8231), (1611763, 7568), (1619331, 8472), (1627803, 8052), (1635855, 8506), (1644361, 8344), (1652705, 7115), (1659820, 8156), (1667976, 7778), (1675754, 8102), (1683856, 8185), (1692041, 8232), (1700273, 8062), (1708335, 8373), (1716708, 8240), (1724948, 7794), (1732742, 8035), (1740777, 7785), (1748562, 8111), (1756673, 8341), (1765014, 8079), (1773093, 7386), (1780479, 8906), (1789385, 7943), (1797328, 7689), (1805017, 7892), (1812909, 7947), (1820856, 7385), (1828241, 8264), (1836505, 8035), (1844540, 8665), (1853205, 8111), (1861316, 7618), (1868934, 8333), (1877267, 7924), (1885191, 8766), (1893957, 7651), (1901608, 7654), (1909262, 6947), (1916209, 8335), (1924544, 8100), (1932644, 8413), (1941057, 7767), (1948824, 8107), (1956931, 7726), (1964657, 8454), (1973111, 7767), (1980878, 7295), (1988173, 7818), (1995991, 7525), (2003516, 8189), (2011705, 8510), (2020215, 8391), (2028606, 7636), (2036242, 7721), (2043963, 8015)], [(2051978, 933), (2052911, 715), (2053626, 754), (2054380, 941), (2055321, 638), (2055959, 785), (2056744, 671), (2057415, 970), (2058385, 721), (2059106, 729), (2059835, 641), (2060476, 660), (2061136, 827), (2061963, 885), (2062848, 1022), (2063870, 924), (2064794, 1363), (2066157, 736), (2066893, 987), (2067880, 836), (2068716, 779), (2069495, 864), (2070359, 969), (2071328, 765), (2072093, 799), (2072892, 715), (2073607, 1063), (2074670, 1266), (2075936, 797), (2076733, 853), (2077586, 1037), (2078623, 892), (2079515, 673), (2080188, 790), (2080978, 892), (2081870, 888), (2082758, 822), (2083580, 799), (2084379, 777), (2085156, 1087), (2086243, 726), (2086969, 866), (2087835, 816), (2088651, 784), (2089435, 803), (2090238, 544), (2090782, 1086), (2091868, 1027), (2092895, 867), (2093762, 619), (2094381, 882), (2095263, 734), (2095997, 762), (2096759, 1065), (2097824, 1094), (2098918, 572), (2099490, 729), (2100219, 697), (2100916, 702), (2101618, 903), (2102521, 850), (2103371, 832), (2104203, 1135), (2105338, 1038), (2106376, 793), (2107169, 793), (2107962, 790), (2108752, 511), (2109263, 679), (2109942, 633), (2110575, 803), (2111378, 1001), (2112379, 689), (2113068, 880), (2113948, 664), (2114612, 786), (2115398, 705), (2116103, 738), (2116841, 843), (2117684, 571), (2118255, 875), (2119130, 724), (2119854, 942), (2120796, 700), (2121496, 739), (2122235, 496), (2122731, 712), (2123443, 817), (2124260, 929), (2125189, 833), (2126022, 1050), (2127072, 1220), (2128292, 919), (2129211, 941), (2130152, 817), (2130969, 476), (2131445, 996), (2132441, 871), (2133312, 675), (2133987, 721), (2134708, 800), (2135508, 957), (2136465, 966), (2137431, 619), (2138050, 652), (2138702, 913), (2139615, 533), (2140148, 541), (2140689, 1018), (2141707, 1032), (2142739, 802), (2143541, 836), (2144377, 803), (2145180, 780), (2145960, 767), (2146727, 774), (2147501, 718), (2148219, 597), (2148816, 787), (2149603, 728), (2150331, 1115), (2151446, 772), (2152218, 871), (2153089, 515), (2153604, 741), (2154345, 882), (2155227, 880), (2156107, 1026), (2157133, 767), (2157900, 1017), (2158917, 873), (2159790, 650), (2160440, 939), (2161379, 712), (2162091, 903), (2162994, 795), (2163789, 753), (2164542, 711), (2165253, 781), (2166034, 674), (2166708, 747), (2167455, 713), (2168168, 824), (2168992, 651), (2169643, 545), (2170188, 620), (2170808, 731), (2171539, 668), (2172207, 790), (2172997, 702), (2173699, 823), (2174522, 601), (2175123, 659), (2175782, 789), (2176571, 741), (2177312, 713), (2178025, 784), (2178809, 1040), (2179849, 773), (2180622, 686), (2181308, 1044), (2182352, 911), (2183263, 716), (2183979, 804), (2184783, 938), (2185721, 736), (2186457, 745), (2187202, 665), (2187867, 787), (2188654, 769), (2189423, 882), (2190305, 677), (2190982, 950), (2191932, 832), (2192764, 904), (2193668, 833), (2194501, 737), (2195238, 630), (2195868, 792), (2196660, 840), (2197500, 1552), (2199052, 594), (2199646, 837), (2200483, 710), (2201193, 1025), (2202218, 888), (2203106, 870), (2203976, 653), (2204629, 674), (2205303, 925), (2206228, 638), (2206866, 603), (2207469, 887), (2208356, 800), (2209156, 948), (2210104, 825), (2210929, 810), (2211739, 781), (2212520, 915), (2213435, 731), (2214166, 982), (2215148, 737), (2215885, 879), (2216764, 640), (2217404, 823), (2218227, 641), (2218868, 946), (2219814, 914), (2220728, 772), (2221500, 1036), (2222536, 780), (2223316, 906), (2224222, 999), (2225221, 1146), (2226367, 973), (2227340, 788), (2228128, 1020), (2229148, 830), (2229978, 589), (2230567, 495), (2231062, 893), (2231955, 794), (2232749, 589), (2233338, 1102), (2234440, 579), (2235019, 819), (2235838, 968), (2236806, 949), (2237755, 908), (2238663, 746), (2239409, 933), (2240342, 763), (2241105, 913), (2242018, 619), (2242637, 700), (2243337, 534), (2243871, 719), (2244590, 486), (2245076, 878), (2245954, 962), (2246916, 881), (2247797, 751), (2248548, 675), (2249223, 696), (2249919, 995), (2250914, 556), (2251470, 638), (2252108, 935), (2253043, 519), (2253562, 976), (2254538, 2165), (2256703, 727), (2257430, 749), (2258179, 975), (2259154, 1094), (2260248, 515)], [(2260763, 48), None, (2260811, 35), (2260846, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2260888, 42), None, (2260930, 25), (2260955, 44), (2260999, 22), (2261021, 18), None, None, None, None, (2261039, 26), None, None, None, None, (2261065, 21), (2261086, 25), None, None, (2261111, 26), None, None, None, None, (2261137, 71), (2261208, 21), (2261229, 23), None, None, None, None, (2261252, 48), None, None, None, None, None, (2261300, 31), None, None, None, None, (2261331, 42), None, (2261373, 22), None, (2261395, 21), None, (2261416, 26), (2261442, 42), None, None, (2261484, 77), None, None, None, None, None, (2261561, 21), (2261582, 21), None, None, (2261603, 34), (2261637, 42), None, None, None, (2261679, 25), None, None, (2261704, 21), None, None, None, None, None, (2261725, 24), (2261749, 21), None, None, (2261770, 26), None, (2261796, 18), None, (2261814, 54), None, None, None, None, None, None, (2261868, 26), None, None, None, (2261894, 20), None, None, (2261914, 42), (2261956, 42), (2261998, 17), (2262015, 17), (2262032, 26), None, (2262058, 26), None, None, None, (2262084, 26), (2262110, 20), (2262130, 26), None, (2262156, 42), (2262198, 63), None, None, None, (2262261, 40), (2262301, 48), None, None, None, (2262349, 47), None, None, None, None, None, None, None, (2262396, 42), None, (2262438, 80), None, (2262518, 9), None, (2262527, 21), (2262548, 42), None, None, (2262590, 65), (2262655, 82), None, None, (2262737, 42), None, None, None, (2262779, 21), None, None, None, None, None, (2262800, 42), (2262842, 21), (2262863, 21), None, (2262884, 42), (2262926, 25), None, (2262951, 16), (2262967, 21), (2262988, 56), None, None, (2263044, 21), (2263065, 19), (2263084, 26), None, (2263110, 16), None, (2263126, 21), None, None, (2263147, 38), None, (2263185, 22), (2263207, 21), (2263228, 21), (2263249, 21), None, (2263270, 63), None, (2263333, 21), (2263354, 42), None, (2263396, 17), None, None, None, None, (2263413, 21), (2263434, 21), None, None, (2263455, 21), None, None, (2263476, 21), None, (2263497, 26), None, (2263523, 50), None, None, None, (2263573, 50), (2263623, 26), (2263649, 21), (2263670, 21), (2263691, 19), None, (2263710, 35), (2263745, 26), (2263771, 23), (2263794, 39), (2263833, 42), None, None, None, None, None, None, (2263875, 21), None, None, None, (2263896, 21), None, None, (2263917, 90), None, (2264007, 239), (2264246, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
