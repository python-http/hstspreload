"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.6.14"
__checksum__ = "0ba48d16a7aa7a06dc1cc03e0d9636139e49fd46490d6a0711b4a0a1c0780d87"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 16), (352, 10), (362, 28), None, (390, 54), (444, 8), (452, 18), (470, 19), (489, 13), (502, 14), (516, 14), None, None, (530, 29), (559, 20), (579, 35), (614, 14), (628, 24), (652, 9), None, (661, 25), (686, 27), (713, 8), (721, 13), None, None, (734, 17), (751, 6), (757, 26), (783, 5), (788, 5), (793, 10), (803, 14), (817, 11), (828, 12), (840, 27), None, (867, 11), (878, 11), (889, 7), (896, 29), (925, 18), (943, 27), (970, 46), (1016, 25), (1041, 16), (1057, 8), (1065, 5), (1070, 22), (1092, 18), None, (1110, 36), (1146, 15), (1161, 8), (1169, 11), None, (1180, 5), (1185, 16), (1201, 14), (1215, 18), None, (1233, 14), (1247, 18), (1265, 48), (1313, 19), (1332, 5), (1337, 59), (1396, 14), (1410, 14), (1424, 20), None, (1444, 10), (1454, 13), (1467, 15), (1482, 19), None, (1501, 13), (1514, 19), (1533, 11), (1544, 4), (1548, 22), (1570, 10), (1580, 7), (1587, 14), (1601, 21), (1622, 11), (1633, 21), (1654, 12), (1666, 32), None, (1698, 10), (1708, 14), (1722, 12), (1734, 45), (1779, 15), None, (1794, 11), (1805, 23), (1828, 21), (1849, 26), (1875, 6), (1881, 6), (1887, 7), (1894, 5), (1899, 20), (1919, 23), (1942, 24), (1966, 13), (1979, 15), (1994, 19), (2013, 6), (2019, 61), (2080, 44), (2124, 12), (2136, 23), (2159, 16), (2175, 38), (2213, 6), (2219, 12), (2231, 44), (2275, 6), (2281, 41), (2322, 13), (2335, 23), (2358, 30), (2388, 16), (2404, 8), (2412, 15), (2427, 12), (2439, 19), (2458, 21), (2479, 15), None, (2494, 35), (2529, 21), (2550, 17), (2567, 19), (2586, 26), (2612, 5), (2617, 37), (2654, 26), (2680, 16), (2696, 10), (2706, 17), (2723, 23), (2746, 14), (2760, 17), (2777, 8), (2785, 8), (2793, 7), (2800, 29), (2829, 6), (2835, 18), (2853, 27), (2880, 20), (2900, 17), (2917, 19), (2936, 12), (2948, 40), (2988, 40), (3028, 12), (3040, 48), (3088, 25), (3113, 12), None, (3125, 8), (3133, 25), (3158, 19), (3177, 6), (3183, 23), None, (3206, 30), (3236, 33), (3269, 14), (3283, 12), (3295, 27), None, (3322, 26), (3348, 41), (3389, 50), (3439, 15), (3454, 20), (3474, 15), (3489, 21), (3510, 32), (3542, 24), (3566, 20), (3586, 17), (3603, 60), (3663, 19), (3682, 9), (3691, 12), (3703, 12), (3715, 11), (3726, 10), (3736, 48), (3784, 32), None, (3816, 25), (3841, 23), None, (3864, 8), (3872, 8), (3880, 7), None, (3887, 25), (3912, 17), None, (3929, 21), (3950, 35), (3985, 21), (4006, 10), (4016, 36), (4052, 20), (4072, 22), (4094, 23), (4117, 19), (4136, 12), (4148, 5), (4153, 30), (4183, 24), (4207, 14), (4221, 14), (4235, 47), (4282, 52), None, None, (4334, 51), (4385, 42), None, (4427, 14), None, (4441, 15), (4456, 8), (4464, 21), (4485, 6), (4491, 16), (4507, 17)], [(4524, 7994), (12518, 8555), (21073, 8903), (29976, 7610), (37586, 8012), (45598, 7892), (53490, 8713), (62203, 7711), (69914, 8619), (78533, 7915), (86448, 9288), (95736, 7772), (103508, 8485), (111993, 9694), (121687, 8193), (129880, 8453), (138333, 8906), (147239, 7877), (155116, 8165), (163281, 7875), (171156, 8669), (179825, 8274), (188099, 8677), (196776, 7979), (204755, 8542), (213297, 8123), (221420, 8625), (230045, 8812), (238857, 7885), (246742, 8308), (255050, 8570), (263620, 8117), (271737, 8299), (280036, 8690), (288726, 7619), (296345, 8353), (304698, 8212), (312910, 8898), (321808, 8560), (330368, 8628), (338996, 9164), (348160, 7888), (356048, 7929), (363977, 7978), (371955, 8047), (380002, 8102), (388104, 8229), (396333, 9041), (405374, 8094), (413468, 7772), (421240, 8117), (429357, 8538), (437895, 8667), (446562, 8521), (455083, 8729), (463812, 8317), (472129, 8653), (480782, 8246), (489028, 8696), (497724, 7263), (504987, 8239), (513226, 8393), (521619, 8253), (529872, 8628), (538500, 8505), (547005, 8723), (555728, 8036), (563764, 8983), (572747, 8775), (581522, 8462), (589984, 8291), (598275, 7967), (606242, 7507), (613749, 8618), (622367, 8457), (630824, 8973), (639797, 7707), (647504, 8880), (656384, 8699), (665083, 7855), (672938, 8719), (681657, 7158), (688815, 8255), (697070, 8660), (705730, 7952), (713682, 8438), (722120, 8942), (731062, 8314), (739376, 8547), (747923, 8510), (756433, 9348), (765781, 7800), (773581, 8146), (781727, 8219), (789946, 8282), (798228, 8959), (807187, 8695), (815882, 8056), (823938, 8057), (831995, 7873), (839868, 7909), (847777, 8451), (856228, 8121), (864349, 8115), (872464, 7893), (880357, 8858), (889215, 8914), (898129, 8773), (906902, 9470), (916372, 8755), (925127, 8566), (933693, 8641), (942334, 8293), (950627, 8212), (958839, 8594), (967433, 8662), (976095, 8288), (984383, 7944), (992327, 8139), (1000466, 8967), (1009433, 8810), (1018243, 8738), (1026981, 8389), (1035370, 8640), (1044010, 9431), (1053441, 8098), (1061539, 7579), (1069118, 8943), (1078061, 8276), (1086337, 10047), (1096384, 8914), (1105298, 7925), (1113223, 8596), (1121819, 8353), (1130172, 8113), (1138285, 8544), (1146829, 7974), (1154803, 8843), (1163646, 8001), (1171647, 8286), (1179933, 8489), (1188422, 8606), (1197028, 7692), (1204720, 8058), (1212778, 8305), (1221083, 8110), (1229193, 8206), (1237399, 8220), (1245619, 8013), (1253632, 8770), (1262402, 8529), (1270931, 8555), (1279486, 8749), (1288235, 8097), (1296332, 8377), (1304709, 8540), (1313249, 8154), (1321403, 8366), (1329769, 7987), (1337756, 7487), (1345243, 7689), (1352932, 8596), (1361528, 9001), (1370529, 8128), (1378657, 8135), (1386792, 9018), (1395810, 8245), (1404055, 7905), (1411960, 8785), (1420745, 8356), (1429101, 7347), (1436448, 8303), (1444751, 9687), (1454438, 7827), (1462265, 7908), (1470173, 8738), (1478911, 8276), (1487187, 8733), (1495920, 8155), (1504075, 7895), (1511970, 10373), (1522343, 8710), (1531053, 8262), (1539315, 8600), (1547915, 9251), (1557166, 9175), (1566341, 7749), (1574090, 8595), (1582685, 8005), (1590690, 8301), (1598991, 9046), (1608037, 8088), (1616125, 8642), (1624767, 8563), (1633330, 8276), (1641606, 8304), (1649910, 8081), (1657991, 8188), (1666179, 8448), (1674627, 8106), (1682733, 8579), (1691312, 7904), (1699216, 8846), (1708062, 8410), (1716472, 9010), (1725482, 8768), (1734250, 7515), (1741765, 8778), (1750543, 8132), (1758675, 8527), (1767202, 8581), (1775783, 8740), (1784523, 8392), (1792915, 8700), (1801615, 8492), (1810107, 8221), (1818328, 8382), (1826710, 8129), (1834839, 8476), (1843315, 8709), (1852024, 8446), (1860470, 7756), (1868226, 9393), (1877619, 8182), (1885801, 8298), (1894099, 8310), (1902409, 8244), (1910653, 7773), (1918426, 8611), (1927037, 8425), (1935462, 9040), (1944502, 8302), (1952804, 7909), (1960713, 8923), (1969636, 8323), (1977959, 9172), (1987131, 7915), (1995046, 8105), (2003151, 7454), (2010605, 8674), (2019279, 8675), (2027954, 8877), (2036831, 8110), (2044941, 8507), (2053448, 8150), (2061598, 8867), (2070465, 8070), (2078535, 7740), (2086275, 8225), (2094500, 7868), (2102368, 8600), (2110968, 8871), (2119839, 8774), (2128613, 7996), (2136609, 8280), (2144889, 8437)], [(2153326, 933), (2154259, 734), (2154993, 811), (2155804, 960), (2156764, 660), (2157424, 838), (2158262, 671), (2158933, 1000), (2159933, 721), (2160654, 771), (2161425, 656), (2162081, 660), (2162741, 827), (2163568, 872), (2164440, 1067), (2165507, 1004), (2166511, 1363), (2167874, 736), (2168610, 1008), (2169618, 855), (2170473, 779), (2171252, 879), (2172131, 1017), (2173148, 789), (2173937, 811), (2174748, 733), (2175481, 1077), (2176558, 1327), (2177885, 788), (2178673, 869), (2179542, 1095), (2180637, 892), (2181529, 697), (2182226, 842), (2183068, 981), (2184049, 948), (2184997, 847), (2185844, 874), (2186718, 832), (2187550, 1191), (2188741, 726), (2189467, 941), (2190408, 783), (2191191, 784), (2191975, 803), (2192778, 561), (2193339, 1086), (2194425, 1027), (2195452, 919), (2196371, 619), (2196990, 897), (2197887, 734), (2198621, 812), (2199433, 1092), (2200525, 1094), (2201619, 593), (2202212, 767), (2202979, 683), (2203662, 728), (2204390, 892), (2205282, 905), (2206187, 859), (2207046, 1133), (2208179, 1078), (2209257, 835), (2210092, 788), (2210880, 809), (2211689, 511), (2212200, 719), (2212919, 625), (2213544, 826), (2214370, 1001), (2215371, 689), (2216060, 880), (2216940, 700), (2217640, 797), (2218437, 705), (2219142, 775), (2219917, 882), (2220799, 586), (2221385, 892), (2222277, 724), (2223001, 991), (2223992, 701), (2224693, 804), (2225497, 548), (2226045, 761), (2226806, 859), (2227665, 943), (2228608, 875), (2229483, 1092), (2230575, 1262), (2231837, 919), (2232756, 925), (2233681, 842), (2234523, 530), (2235053, 996), (2236049, 887), (2236936, 675), (2237611, 738), (2238349, 848), (2239197, 1042), (2240239, 980), (2241219, 608), (2241827, 674), (2242501, 940), (2243441, 533), (2243974, 589), (2244563, 1018), (2245581, 1032), (2246613, 821), (2247434, 852), (2248286, 803), (2249089, 801), (2249890, 880), (2250770, 823), (2251593, 731), (2252324, 610), (2252934, 801), (2253735, 744), (2254479, 1136), (2255615, 757), (2256372, 904), (2257276, 552), (2257828, 801), (2258629, 914), (2259543, 910), (2260453, 1072), (2261525, 767), (2262292, 1079), (2263371, 925), (2264296, 630), (2264926, 939), (2265865, 787), (2266652, 977), (2267629, 808), (2268437, 753), (2269190, 741), (2269931, 840), (2270771, 706), (2271477, 760), (2272237, 744), (2272981, 824), (2273805, 651), (2274456, 577), (2275033, 637), (2275670, 750), (2276420, 701), (2277121, 824), (2277945, 718), (2278663, 815), (2279478, 602), (2280080, 638), (2280718, 893), (2281611, 789), (2282400, 736), (2283136, 818), (2283954, 1084), (2285038, 828), (2285866, 664), (2286530, 1069), (2287599, 922), (2288521, 720), (2289241, 826), (2290067, 993), (2291060, 736), (2291796, 745), (2292541, 706), (2293247, 756), (2294003, 799), (2294802, 898), (2295700, 677), (2296377, 993), (2297370, 811), (2298181, 939), (2299120, 911), (2300031, 793), (2300824, 630), (2301454, 792), (2302246, 820), (2303066, 1986), (2305052, 610), (2305662, 843), (2306505, 731), (2307236, 1068), (2308304, 913), (2309217, 863), (2310080, 666), (2310746, 704), (2311450, 947), (2312397, 638), (2313035, 611), (2313646, 902), (2314548, 814), (2315362, 964), (2316326, 854), (2317180, 810), (2317990, 763), (2318753, 908), (2319661, 781), (2320442, 961), (2321403, 757), (2322160, 879), (2323039, 688), (2323727, 846), (2324573, 675), (2325248, 981), (2326229, 975), (2327204, 792), (2327996, 1065), (2329061, 780), (2329841, 933), (2330774, 1006), (2331780, 1146), (2332926, 945), (2333871, 866), (2334737, 1006), (2335743, 810), (2336553, 633), (2337186, 490), (2337676, 908), (2338584, 827), (2339411, 589), (2340000, 1117), (2341117, 594), (2341711, 824), (2342535, 969), (2343504, 972), (2344476, 925), (2345401, 746), (2346147, 962), (2347109, 797), (2347906, 949), (2348855, 674), (2349529, 700), (2350229, 619), (2350848, 698), (2351546, 486), (2352032, 900), (2352932, 1038), (2353970, 926), (2354896, 751), (2355647, 707), (2356354, 709), (2357063, 1046), (2358109, 616), (2358725, 625), (2359350, 982), (2360332, 519), (2360851, 990), (2361841, 2180), (2364021, 727), (2364748, 785), (2365533, 1003), (2366536, 1161), (2367697, 515)], [(2368212, 48), None, (2368260, 35), (2368295, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2368337, 42), None, (2368379, 25), (2368404, 44), (2368448, 22), (2368470, 18), None, None, None, None, (2368488, 26), None, None, None, None, (2368514, 21), (2368535, 25), None, None, (2368560, 26), None, None, None, None, (2368586, 71), (2368657, 21), (2368678, 23), None, None, None, None, (2368701, 48), None, None, None, None, None, (2368749, 31), None, None, None, None, (2368780, 42), None, (2368822, 22), None, (2368844, 21), None, (2368865, 26), (2368891, 42), None, None, (2368933, 77), (2369010, 27), None, None, None, None, (2369037, 21), (2369058, 21), None, None, (2369079, 34), (2369113, 42), None, None, None, (2369155, 25), None, None, (2369180, 21), None, None, None, None, None, (2369201, 24), (2369225, 21), None, None, (2369246, 26), None, (2369272, 18), None, (2369290, 54), None, None, None, None, None, None, (2369344, 26), None, None, None, (2369370, 20), None, None, (2369390, 64), (2369454, 42), (2369496, 17), (2369513, 17), (2369530, 26), None, (2369556, 26), None, None, None, (2369582, 26), (2369608, 20), (2369628, 26), None, (2369654, 42), (2369696, 63), None, None, None, (2369759, 40), (2369799, 48), None, None, None, (2369847, 47), None, None, None, None, None, None, None, (2369894, 42), None, (2369936, 80), None, (2370016, 9), None, (2370025, 21), (2370046, 42), None, None, (2370088, 65), (2370153, 82), None, None, (2370235, 42), None, None, (2370277, 24), (2370301, 21), None, None, None, None, None, (2370322, 42), (2370364, 21), (2370385, 21), None, (2370406, 42), (2370448, 25), None, (2370473, 38), (2370511, 21), (2370532, 56), None, None, (2370588, 21), (2370609, 19), (2370628, 26), None, (2370654, 16), None, (2370670, 21), None, None, (2370691, 38), None, (2370729, 22), (2370751, 21), (2370772, 21), (2370793, 21), None, (2370814, 63), None, (2370877, 21), (2370898, 42), None, (2370940, 17), None, None, None, None, (2370957, 21), (2370978, 21), None, None, (2370999, 21), None, None, (2371020, 21), None, (2371041, 26), None, (2371067, 50), None, None, None, (2371117, 50), (2371167, 26), (2371193, 21), (2371214, 21), (2371235, 19), None, (2371254, 35), (2371289, 26), (2371315, 23), (2371338, 39), (2371377, 42), None, None, None, None, None, None, (2371419, 21), None, None, None, (2371440, 21), None, None, (2371461, 90), None, (2371551, 239), (2371790, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
