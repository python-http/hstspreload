"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.5.17"
__checksum__ = "02116daf978a7eae3d8adf991fc9527256b3ad2ddb270a08b0119d23510d3e89"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 59), (1398, 14), (1412, 14), (1426, 20), None, (1446, 10), (1456, 13), (1469, 15), (1484, 19), None, (1503, 13), (1516, 19), (1535, 11), (1546, 4), (1550, 22), (1572, 10), (1582, 7), (1589, 14), (1603, 21), (1624, 11), (1635, 21), (1656, 12), (1668, 32), None, (1700, 10), (1710, 14), (1724, 12), (1736, 45), (1781, 15), None, (1796, 11), (1807, 23), (1830, 21), (1851, 26), (1877, 6), (1883, 6), (1889, 7), (1896, 5), (1901, 20), (1921, 23), (1944, 24), (1968, 13), (1981, 15), (1996, 19), (2015, 6), (2021, 61), (2082, 44), (2126, 12), (2138, 23), (2161, 16), (2177, 38), (2215, 6), (2221, 12), (2233, 44), (2277, 6), (2283, 41), (2324, 13), (2337, 23), (2360, 30), (2390, 16), (2406, 8), (2414, 15), (2429, 12), (2441, 19), (2460, 21), (2481, 15), None, (2496, 35), (2531, 21), (2552, 17), (2569, 19), (2588, 26), (2614, 5), (2619, 37), (2656, 26), (2682, 16), (2698, 10), (2708, 17), (2725, 23), (2748, 14), (2762, 17), (2779, 8), (2787, 4), (2791, 7), (2798, 29), (2827, 6), (2833, 18), (2851, 27), (2878, 20), (2898, 17), (2915, 19), (2934, 12), (2946, 40), (2986, 40), (3026, 12), (3038, 48), (3086, 25), (3111, 12), None, (3123, 8), (3131, 25), (3156, 19), (3175, 6), (3181, 23), None, (3204, 30), (3234, 33), (3267, 14), (3281, 12), (3293, 27), None, (3320, 26), (3346, 41), (3387, 50), (3437, 15), (3452, 20), (3472, 15), (3487, 21), (3508, 32), (3540, 24), (3564, 20), (3584, 17), (3601, 60), (3661, 19), (3680, 9), (3689, 12), (3701, 12), (3713, 11), (3724, 10), (3734, 48), (3782, 32), None, (3814, 25), (3839, 23), None, (3862, 8), (3870, 8), (3878, 7), None, (3885, 25), (3910, 17), None, (3927, 21), (3948, 35), (3983, 21), (4004, 10), (4014, 36), (4050, 20), (4070, 22), (4092, 23), (4115, 19), (4134, 12), (4146, 5), (4151, 30), (4181, 24), (4205, 14), (4219, 14), (4233, 47), (4280, 52), None, None, (4332, 51), (4383, 42), None, (4425, 14), None, (4439, 15), (4454, 8), (4462, 21), (4483, 6), (4489, 16), (4505, 17)], [(4522, 7759), (12281, 8227), (20508, 8608), (29116, 7394), (36510, 7758), (44268, 7385), (51653, 8356), (60009, 7337), (67346, 8352), (75698, 7610), (83308, 8988), (92296, 7548), (99844, 8071), (107915, 9436), (117351, 7928), (125279, 8061), (133340, 8525), (141865, 7439), (149304, 7837), (157141, 7615), (164756, 8323), (173079, 8043), (181122, 8479), (189601, 7526), (197127, 8145), (205272, 7941), (213213, 8307), (221520, 8575), (230095, 7692), (237787, 7961), (245748, 8439), (254187, 7838), (262025, 7969), (269994, 8402), (278396, 7465), (285861, 8017), (293878, 8017), (301895, 8623), (310518, 8266), (318784, 8303), (327087, 8939), (336026, 7609), (343635, 7761), (351396, 7658), (359054, 7807), (366861, 7820), (374681, 7947), (382628, 8749), (391377, 7911), (399288, 7394), (406682, 7874), (414556, 8309), (422865, 8394), (431259, 8258), (439517, 8509), (448026, 7976), (456002, 8413), (464415, 8039), (472454, 8511), (480965, 6996), (487961, 8041), (496002, 8045), (504047, 7937), (511984, 8488), (520472, 8276), (528748, 8511), (537259, 7728), (544987, 8681), (553668, 8509), (562177, 8202), (570379, 7994), (578373, 7708), (586081, 7319), (593400, 8440), (601840, 8281), (610121, 8623), (618744, 7496), (626240, 8597), (634837, 8463), (643300, 7677), (650977, 8387), (659364, 6968), (666332, 7979), (674311, 8309), (682620, 7784), (690404, 8037), (698441, 8540), (706981, 8104), (715085, 8372), (723457, 8203), (731660, 8990), (740650, 7379), (748029, 7918), (755947, 7941), (763888, 8204), (772092, 8692), (780784, 8530), (789314, 7717), (797031, 7885), (804916, 7669), (812585, 7715), (820300, 8111), (828411, 7855), (836266, 7873), (844139, 7650), (851789, 8525), (860314, 8432), (868746, 8552), (877298, 9268), (886566, 8554), (895120, 8178), (903298, 8342), (911640, 7887), (919527, 7814), (927341, 8335), (935676, 8469), (944145, 7976), (952121, 7686), (959807, 7843), (967650, 8759), (976409, 8536), (984945, 8525), (993470, 8155), (1001625, 8436), (1010061, 9269), (1019330, 7894), (1027224, 7288), (1034512, 8606), (1043118, 8110), (1051228, 9841), (1061069, 8645), (1069714, 7664), (1077378, 8373), (1085751, 8188), (1093939, 7724), (1101663, 8334), (1109997, 7783), (1117780, 8514), (1126294, 7900), (1134194, 8115), (1142309, 8232), (1150541, 8500), (1159041, 7403), (1166444, 7765), (1174209, 8172), (1182381, 7781), (1190162, 7880), (1198042, 8068), (1206110, 7682), (1213792, 8510), (1222302, 8252), (1230554, 8302), (1238856, 8499), (1247355, 7909), (1255264, 8139), (1263403, 8189), (1271592, 8036), (1279628, 8078), (1287706, 7736), (1295442, 7261), (1302703, 7492), (1310195, 8349), (1318544, 8765), (1327309, 7830), (1335139, 7796), (1342935, 8744), (1351679, 7876), (1359555, 7469), (1367024, 8572), (1375596, 8182), (1383778, 7097), (1390875, 7951), (1398826, 9471), (1408297, 7503), (1415800, 7626), (1423426, 8372), (1431798, 7873), (1439671, 8380), (1448051, 7857), (1455908, 7427), (1463335, 8999), (1472334, 8481), (1480815, 7802), (1488617, 8449), (1497066, 9057), (1506123, 8808), (1514931, 7466), (1522397, 8400), (1530797, 7828), (1538625, 8115), (1546740, 8680), (1555420, 7798), (1563218, 8387), (1571605, 8303), (1579908, 8016), (1587924, 8045), (1595969, 7817), (1603786, 7996), (1611782, 8046), (1619828, 7741), (1627569, 8312), (1635881, 7622), (1643503, 8556), (1652059, 8153), (1660212, 8623), (1668835, 8449), (1677284, 7326), (1684610, 8333), (1692943, 7949), (1700892, 8285), (1709177, 8355), (1717532, 8433), (1725965, 8124), (1734089, 8530), (1742619, 8381), (1751000, 7891), (1758891, 8231), (1767122, 7842), (1774964, 8240), (1783204, 8394), (1791598, 8135), (1799733, 7474), (1807207, 9079), (1816286, 8041), (1824327, 7924), (1832251, 8071), (1840322, 8025), (1848347, 7552), (1855899, 8350), (1864249, 8250), (1872499, 8750), (1881249, 8206), (1889455, 7729), (1897184, 8513), (1905697, 8004), (1913701, 8801), (1922502, 7752), (1930254, 7803), (1938057, 7205), (1945262, 8450), (1953712, 8265), (1961977, 8544), (1970521, 7855), (1978376, 8307), (1986683, 7894), (1994577, 8592), (2003169, 7811), (2010980, 7403), (2018383, 7918), (2026301, 7619), (2033920, 8278), (2042198, 8669), (2050867, 8571), (2059438, 7701), (2067139, 7838), (2074977, 8217)], [(2083194, 933), (2084127, 715), (2084842, 754), (2085596, 941), (2086537, 638), (2087175, 785), (2087960, 671), (2088631, 1000), (2089631, 704), (2090335, 729), (2091064, 641), (2091705, 660), (2092365, 827), (2093192, 885), (2094077, 1067), (2095144, 924), (2096068, 1363), (2097431, 736), (2098167, 1008), (2099175, 855), (2100030, 779), (2100809, 845), (2101654, 984), (2102638, 765), (2103403, 778), (2104181, 715), (2104896, 1063), (2105959, 1312), (2107271, 797), (2108068, 853), (2108921, 1037), (2109958, 892), (2110850, 673), (2111523, 842), (2112365, 892), (2113257, 888), (2114145, 847), (2114992, 832), (2115824, 806), (2116630, 1130), (2117760, 726), (2118486, 893), (2119379, 783), (2120162, 784), (2120946, 803), (2121749, 561), (2122310, 1086), (2123396, 1027), (2124423, 867), (2125290, 619), (2125909, 897), (2126806, 734), (2127540, 762), (2128302, 1048), (2129350, 1094), (2130444, 572), (2131016, 746), (2131762, 697), (2132459, 702), (2133161, 903), (2134064, 850), (2134914, 832), (2135746, 1118), (2136864, 1058), (2137922, 835), (2138757, 810), (2139567, 787), (2140354, 511), (2140865, 696), (2141561, 625), (2142186, 826), (2143012, 1001), (2144013, 689), (2144702, 880), (2145582, 679), (2146261, 797), (2147058, 705), (2147763, 738), (2148501, 843), (2149344, 571), (2149915, 875), (2150790, 724), (2151514, 964), (2152478, 701), (2153179, 769), (2153948, 515), (2154463, 712), (2155175, 859), (2156034, 943), (2156977, 841), (2157818, 1092), (2158910, 1243), (2160153, 919), (2161072, 925), (2161997, 842), (2162839, 489), (2163328, 996), (2164324, 871), (2165195, 675), (2165870, 721), (2166591, 825), (2167416, 992), (2168408, 966), (2169374, 619), (2169993, 652), (2170645, 913), (2171558, 533), (2172091, 572), (2172663, 1018), (2173681, 1032), (2174713, 821), (2175534, 852), (2176386, 803), (2177189, 780), (2177969, 797), (2178766, 797), (2179563, 718), (2180281, 597), (2180878, 801), (2181679, 728), (2182407, 1115), (2183522, 772), (2184294, 889), (2185183, 532), (2185715, 760), (2186475, 882), (2187357, 880), (2188237, 1048), (2189285, 767), (2190052, 1032), (2191084, 896), (2191980, 650), (2192630, 939), (2193569, 767), (2194336, 930), (2195266, 795), (2196061, 753), (2196814, 711), (2197525, 781), (2198306, 692), (2198998, 760), (2199758, 732), (2200490, 824), (2201314, 651), (2201965, 545), (2202510, 637), (2203147, 750), (2203897, 668), (2204565, 804), (2205369, 694), (2206063, 837), (2206900, 601), (2207501, 638), (2208139, 852), (2208991, 741), (2209732, 713), (2210445, 784), (2211229, 1064), (2212293, 793), (2213086, 664), (2213750, 1044), (2214794, 922), (2215716, 720), (2216436, 806), (2217242, 967), (2218209, 736), (2218945, 745), (2219690, 706), (2220396, 787), (2221183, 799), (2221982, 882), (2222864, 677), (2223541, 969), (2224510, 832), (2225342, 904), (2226246, 892), (2227138, 759), (2227897, 630), (2228527, 792), (2229319, 834), (2230153, 1576), (2231729, 610), (2232339, 823), (2233162, 750), (2233912, 1025), (2234937, 913), (2235850, 870), (2236720, 653), (2237373, 674), (2238047, 906), (2238953, 638), (2239591, 617), (2240208, 887), (2241095, 800), (2241895, 948), (2242843, 868), (2243711, 810), (2244521, 763), (2245284, 915), (2246199, 731), (2246930, 948), (2247878, 737), (2248615, 879), (2249494, 657), (2250151, 846), (2250997, 641), (2251638, 981), (2252619, 936), (2253555, 772), (2254327, 1036), (2255363, 780), (2256143, 919), (2257062, 999), (2258061, 1146), (2259207, 957), (2260164, 814), (2260978, 1006), (2261984, 810), (2262794, 589), (2263383, 477), (2263860, 887), (2264747, 811), (2265558, 589), (2266147, 1102), (2267249, 594), (2267843, 824), (2268667, 987), (2269654, 949), (2270603, 925), (2271528, 746), (2272274, 933), (2273207, 797), (2274004, 949), (2274953, 619), (2275572, 700), (2276272, 579), (2276851, 698), (2277549, 486), (2278035, 900), (2278935, 1015), (2279950, 899), (2280849, 751), (2281600, 688), (2282288, 696), (2282984, 1027), (2284011, 594), (2284605, 625), (2285230, 982), (2286212, 519), (2286731, 976), (2287707, 2165), (2289872, 727), (2290599, 767), (2291366, 975), (2292341, 1138), (2293479, 515)], [(2293994, 48), None, (2294042, 35), (2294077, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2294119, 42), None, (2294161, 25), (2294186, 44), (2294230, 22), (2294252, 18), None, None, None, None, (2294270, 26), None, None, None, None, (2294296, 21), (2294317, 25), None, None, (2294342, 26), None, None, None, None, (2294368, 71), (2294439, 21), (2294460, 23), None, None, None, None, (2294483, 48), None, None, None, None, None, (2294531, 31), None, None, None, None, (2294562, 42), None, (2294604, 22), None, (2294626, 21), None, (2294647, 26), (2294673, 42), None, None, (2294715, 77), None, None, None, None, None, (2294792, 21), (2294813, 21), None, None, (2294834, 34), (2294868, 42), None, None, None, (2294910, 25), None, None, (2294935, 21), None, None, None, None, None, (2294956, 24), (2294980, 21), None, None, (2295001, 26), None, (2295027, 18), None, (2295045, 54), None, None, None, None, None, None, (2295099, 26), None, None, None, (2295125, 20), None, None, (2295145, 64), (2295209, 42), (2295251, 17), (2295268, 17), (2295285, 26), None, (2295311, 26), None, None, None, (2295337, 26), (2295363, 20), (2295383, 26), None, (2295409, 42), (2295451, 63), None, None, None, (2295514, 40), (2295554, 48), None, None, None, (2295602, 47), None, None, None, None, None, None, None, (2295649, 42), None, (2295691, 80), None, (2295771, 9), None, (2295780, 21), (2295801, 42), None, None, (2295843, 65), (2295908, 82), None, None, (2295990, 42), None, None, None, (2296032, 21), None, None, None, None, None, (2296053, 42), (2296095, 21), (2296116, 21), None, (2296137, 42), (2296179, 25), None, (2296204, 16), (2296220, 21), (2296241, 56), None, None, (2296297, 21), (2296318, 19), (2296337, 26), None, (2296363, 16), None, (2296379, 21), None, None, (2296400, 38), None, (2296438, 22), (2296460, 21), (2296481, 21), (2296502, 21), None, (2296523, 63), None, (2296586, 21), (2296607, 42), None, (2296649, 17), None, None, None, None, (2296666, 21), (2296687, 21), None, None, (2296708, 21), None, None, (2296729, 21), None, (2296750, 26), None, (2296776, 50), None, None, None, (2296826, 50), (2296876, 26), (2296902, 21), (2296923, 21), (2296944, 19), None, (2296963, 35), (2296998, 26), (2297024, 23), (2297047, 39), (2297086, 42), None, None, None, None, None, None, (2297128, 21), None, None, None, (2297149, 21), None, None, (2297170, 90), None, (2297260, 239), (2297499, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
