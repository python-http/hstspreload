"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.5.3"
__checksum__ = "59da27f93b074047f1bf6856fe928813ef0269b454f362ec7c84b2470d937f74"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 46), (1385, 14), (1399, 14), (1413, 20), None, (1433, 10), (1443, 13), (1456, 15), (1471, 19), None, (1490, 13), (1503, 19), (1522, 11), (1533, 4), (1537, 22), (1559, 10), (1569, 7), (1576, 14), (1590, 21), (1611, 11), (1622, 21), (1643, 12), (1655, 32), None, (1687, 10), (1697, 14), (1711, 12), (1723, 45), (1768, 15), None, (1783, 11), (1794, 23), (1817, 21), (1838, 26), (1864, 6), (1870, 6), (1876, 7), (1883, 5), (1888, 20), (1908, 23), (1931, 24), (1955, 13), (1968, 15), (1983, 19), (2002, 6), (2008, 61), (2069, 44), (2113, 12), (2125, 23), (2148, 16), (2164, 38), (2202, 6), (2208, 12), (2220, 44), (2264, 6), (2270, 41), (2311, 13), (2324, 23), (2347, 30), (2377, 16), (2393, 8), (2401, 15), (2416, 12), (2428, 19), (2447, 21), (2468, 15), None, (2483, 35), (2518, 21), (2539, 17), (2556, 19), (2575, 26), (2601, 5), (2606, 37), (2643, 26), (2669, 16), (2685, 10), (2695, 17), (2712, 23), (2735, 14), (2749, 17), (2766, 8), (2774, 4), (2778, 7), (2785, 29), (2814, 6), (2820, 18), (2838, 27), (2865, 20), (2885, 17), (2902, 19), (2921, 12), (2933, 40), (2973, 40), (3013, 12), (3025, 48), (3073, 25), (3098, 12), None, (3110, 8), (3118, 25), (3143, 19), (3162, 6), (3168, 23), None, (3191, 30), (3221, 33), (3254, 14), (3268, 12), (3280, 27), None, (3307, 26), (3333, 41), (3374, 50), (3424, 15), (3439, 20), (3459, 15), (3474, 21), (3495, 32), (3527, 24), (3551, 20), (3571, 17), (3588, 60), (3648, 19), (3667, 9), (3676, 12), (3688, 12), (3700, 11), (3711, 10), (3721, 48), (3769, 32), None, (3801, 25), (3826, 23), None, (3849, 8), (3857, 8), (3865, 7), None, (3872, 25), (3897, 17), None, (3914, 21), (3935, 35), (3970, 21), (3991, 10), (4001, 36), (4037, 20), (4057, 22), (4079, 23), (4102, 19), (4121, 12), (4133, 5), (4138, 30), (4168, 24), (4192, 14), (4206, 14), (4220, 47), (4267, 52), None, None, (4319, 51), (4370, 42), None, (4412, 14), None, (4426, 15), (4441, 8), (4449, 21), (4470, 6), (4476, 16), (4492, 17)], [(4509, 7684), (12193, 8188), (20381, 8576), (28957, 7343), (36300, 7734), (44034, 7315), (51349, 8327), (59676, 7273), (66949, 8320), (75269, 7603), (82872, 8886), (91758, 7510), (99268, 8056), (107324, 9326), (116650, 7908), (124558, 7956), (132514, 8441), (140955, 7401), (148356, 7822), (156178, 7521), (163699, 8252), (171951, 7975), (179926, 8409), (188335, 7491), (195826, 8062), (203888, 7904), (211792, 8266), (220058, 8529), (228587, 7624), (236211, 7894), (244105, 8361), (252466, 7822), (260288, 7915), (268203, 8354), (276557, 7439), (283996, 7974), (291970, 7860), (299830, 8579), (308409, 8145), (316554, 8289), (324843, 8913), (333756, 7598), (341354, 7692), (349046, 7616), (356662, 7733), (364395, 7751), (372146, 7891), (380037, 8711), (388748, 7811), (396559, 7276), (403835, 7792), (411627, 8300), (419927, 8343), (428270, 8214), (436484, 8432), (444916, 7976), (452892, 8376), (461268, 7930), (469198, 8460), (477658, 6922), (484580, 7993), (492573, 8020), (500593, 7885), (508478, 8409), (516887, 8236), (525123, 8465), (533588, 7681), (541269, 8627), (549896, 8397), (558293, 8160), (566453, 7853), (574306, 7671), (581977, 7260), (589237, 8368), (597605, 8261), (605866, 8556), (614422, 7496), (621918, 8557), (630475, 8340), (638815, 7646), (646461, 8345), (654806, 6954), (661760, 7949), (669709, 8239), (677948, 7751), (685699, 7993), (693692, 8418), (702110, 8074), (710184, 8278), (718462, 8141), (726603, 8935), (735538, 7342), (742880, 7829), (750709, 7941), (758650, 8204), (766854, 8628), (775482, 8539), (784021, 7694), (791715, 7826), (799541, 7669), (807210, 7702), (814912, 8083), (822995, 7790), (830785, 7873), (838658, 7612), (846270, 8476), (854746, 8351), (863097, 8435), (871532, 9209), (880741, 8490), (889231, 8120), (897351, 8271), (905622, 7817), (913439, 7814), (921253, 8271), (929524, 8411), (937935, 7910), (945845, 7587), (953432, 7786), (961218, 8688), (969906, 8483), (978389, 8444), (986833, 8141), (994974, 8435), (1003409, 9262), (1012671, 7839), (1020510, 7231), (1027741, 8509), (1036250, 8059), (1044309, 9761), (1054070, 8624), (1062694, 7626), (1070320, 8296), (1078616, 8142), (1086758, 7675), (1094433, 8334), (1102767, 7768), (1110535, 8340), (1118875, 7788), (1126663, 8102), (1134765, 8175), (1142940, 8442), (1151382, 7383), (1158765, 7718), (1166483, 8134), (1174617, 7759), (1182376, 7824), (1190200, 7968), (1198168, 7594), (1205762, 8443), (1214205, 8205), (1222410, 8263), (1230673, 8405), (1239078, 7837), (1246915, 8109), (1255024, 8111), (1263135, 8006), (1271141, 8060), (1279201, 7623), (1286824, 7208), (1294032, 7430), (1301462, 8280), (1309742, 8672), (1318414, 7760), (1326174, 7705), (1333879, 8712), (1342591, 7833), (1350424, 7449), (1357873, 8472), (1366345, 8161), (1374506, 7048), (1381554, 7938), (1389492, 9401), (1398893, 7469), (1406362, 7600), (1413962, 8317), (1422279, 7818), (1430097, 8255), (1438352, 7813), (1446165, 7416), (1453581, 8969), (1462550, 8415), (1470965, 7767), (1478732, 8438), (1487170, 9002), (1496172, 8731), (1504903, 7408), (1512311, 8364), (1520675, 7775), (1528450, 8064), (1536514, 8570), (1545084, 7810), (1552894, 8371), (1561265, 8293), (1569558, 7966), (1577524, 7944), (1585468, 7786), (1593254, 7962), (1601216, 7993), (1609209, 7683), (1616892, 8292), (1625184, 7590), (1632774, 8513), (1641287, 8141), (1649428, 8502), (1657930, 8406), (1666336, 7181), (1673517, 8267), (1681784, 7927), (1689711, 8210), (1697921, 8268), (1706189, 8346), (1714535, 8110), (1722645, 8484), (1731129, 8264), (1739393, 7832), (1747225, 8127), (1755352, 7806), (1763158, 8224), (1771382, 8348), (1779730, 8105), (1787835, 7400), (1795235, 8979), (1804214, 7991), (1812205, 7847), (1820052, 7950), (1828002, 7997), (1835999, 7461), (1843460, 8296), (1851756, 8146), (1859902, 8723), (1868625, 8152), (1876777, 7689), (1884466, 8403), (1892869, 7935), (1900804, 8787), (1909591, 7707), (1917298, 7730), (1925028, 7164), (1932192, 8368), (1940560, 8221), (1948781, 8462), (1957243, 7833), (1965076, 8249), (1973325, 7767), (1981092, 8562), (1989654, 7788), (1997442, 7369), (2004811, 7843), (2012654, 7609), (2020263, 8244), (2028507, 8619), (2037126, 8457), (2045583, 7681), (2053264, 7755), (2061019, 8116)], [(2069135, 933), (2070068, 715), (2070783, 754), (2071537, 941), (2072478, 638), (2073116, 785), (2073901, 671), (2074572, 987), (2075559, 704), (2076263, 729), (2076992, 641), (2077633, 660), (2078293, 827), (2079120, 885), (2080005, 1043), (2081048, 924), (2081972, 1363), (2083335, 736), (2084071, 1008), (2085079, 836), (2085915, 779), (2086694, 845), (2087539, 984), (2088523, 765), (2089288, 778), (2090066, 715), (2090781, 1063), (2091844, 1279), (2093123, 797), (2093920, 853), (2094773, 1037), (2095810, 892), (2096702, 673), (2097375, 806), (2098181, 892), (2099073, 888), (2099961, 822), (2100783, 832), (2101615, 806), (2102421, 1087), (2103508, 726), (2104234, 893), (2105127, 783), (2105910, 784), (2106694, 803), (2107497, 544), (2108041, 1086), (2109127, 1027), (2110154, 867), (2111021, 619), (2111640, 882), (2112522, 734), (2113256, 762), (2114018, 1048), (2115066, 1094), (2116160, 572), (2116732, 746), (2117478, 697), (2118175, 702), (2118877, 903), (2119780, 850), (2120630, 832), (2121462, 1118), (2122580, 1058), (2123638, 835), (2124473, 810), (2125283, 787), (2126070, 511), (2126581, 696), (2127277, 625), (2127902, 826), (2128728, 1001), (2129729, 689), (2130418, 880), (2131298, 679), (2131977, 797), (2132774, 705), (2133479, 738), (2134217, 843), (2135060, 571), (2135631, 875), (2136506, 724), (2137230, 964), (2138194, 701), (2138895, 769), (2139664, 515), (2140179, 712), (2140891, 845), (2141736, 929), (2142665, 829), (2143494, 1050), (2144544, 1220), (2145764, 919), (2146683, 925), (2147608, 817), (2148425, 489), (2148914, 996), (2149910, 871), (2150781, 675), (2151456, 721), (2152177, 825), (2153002, 957), (2153959, 966), (2154925, 619), (2155544, 652), (2156196, 913), (2157109, 533), (2157642, 572), (2158214, 1018), (2159232, 1032), (2160264, 802), (2161066, 836), (2161902, 803), (2162705, 780), (2163485, 797), (2164282, 797), (2165079, 718), (2165797, 597), (2166394, 801), (2167195, 728), (2167923, 1115), (2169038, 772), (2169810, 871), (2170681, 532), (2171213, 741), (2171954, 882), (2172836, 880), (2173716, 1048), (2174764, 767), (2175531, 1032), (2176563, 896), (2177459, 650), (2178109, 939), (2179048, 730), (2179778, 930), (2180708, 795), (2181503, 753), (2182256, 711), (2182967, 781), (2183748, 692), (2184440, 760), (2185200, 713), (2185913, 824), (2186737, 651), (2187388, 545), (2187933, 637), (2188570, 750), (2189320, 668), (2189988, 804), (2190792, 694), (2191486, 837), (2192323, 601), (2192924, 638), (2193562, 852), (2194414, 741), (2195155, 713), (2195868, 784), (2196652, 1064), (2197716, 773), (2198489, 686), (2199175, 1044), (2200219, 922), (2201141, 720), (2201861, 777), (2202638, 967), (2203605, 736), (2204341, 745), (2205086, 686), (2205772, 787), (2206559, 769), (2207328, 882), (2208210, 677), (2208887, 950), (2209837, 832), (2210669, 904), (2211573, 874), (2212447, 737), (2213184, 630), (2213814, 792), (2214606, 820), (2215426, 1576), (2217002, 594), (2217596, 823), (2218419, 750), (2219169, 1025), (2220194, 913), (2221107, 870), (2221977, 653), (2222630, 674), (2223304, 906), (2224210, 638), (2224848, 617), (2225465, 887), (2226352, 800), (2227152, 948), (2228100, 868), (2228968, 810), (2229778, 763), (2230541, 915), (2231456, 731), (2232187, 965), (2233152, 737), (2233889, 879), (2234768, 640), (2235408, 846), (2236254, 641), (2236895, 962), (2237857, 936), (2238793, 772), (2239565, 1036), (2240601, 780), (2241381, 919), (2242300, 999), (2243299, 1146), (2244445, 973), (2245418, 788), (2246206, 1020), (2247226, 810), (2248036, 589), (2248625, 477), (2249102, 865), (2249967, 811), (2250778, 589), (2251367, 1102), (2252469, 594), (2253063, 819), (2253882, 943), (2254825, 949), (2255774, 908), (2256682, 746), (2257428, 933), (2258361, 763), (2259124, 930), (2260054, 619), (2260673, 700), (2261373, 579), (2261952, 698), (2262650, 486), (2263136, 878), (2264014, 979), (2264993, 899), (2265892, 751), (2266643, 688), (2267331, 696), (2268027, 1027), (2269054, 578), (2269632, 625), (2270257, 982), (2271239, 519), (2271758, 976), (2272734, 2165), (2274899, 727), (2275626, 767), (2276393, 975), (2277368, 1113), (2278481, 515)], [(2278996, 48), None, (2279044, 35), (2279079, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2279121, 42), None, (2279163, 25), (2279188, 44), (2279232, 22), (2279254, 18), None, None, None, None, (2279272, 26), None, None, None, None, (2279298, 21), (2279319, 25), None, None, (2279344, 26), None, None, None, None, (2279370, 71), (2279441, 21), (2279462, 23), None, None, None, None, (2279485, 48), None, None, None, None, None, (2279533, 31), None, None, None, None, (2279564, 42), None, (2279606, 22), None, (2279628, 21), None, (2279649, 26), (2279675, 42), None, None, (2279717, 77), None, None, None, None, None, (2279794, 21), (2279815, 21), None, None, (2279836, 34), (2279870, 42), None, None, None, (2279912, 25), None, None, (2279937, 21), None, None, None, None, None, (2279958, 24), (2279982, 21), None, None, (2280003, 26), None, (2280029, 18), None, (2280047, 54), None, None, None, None, None, None, (2280101, 26), None, None, None, (2280127, 20), None, None, (2280147, 42), (2280189, 42), (2280231, 17), (2280248, 17), (2280265, 26), None, (2280291, 26), None, None, None, (2280317, 26), (2280343, 20), (2280363, 26), None, (2280389, 42), (2280431, 63), None, None, None, (2280494, 40), (2280534, 48), None, None, None, (2280582, 47), None, None, None, None, None, None, None, (2280629, 42), None, (2280671, 80), None, (2280751, 9), None, (2280760, 21), (2280781, 42), None, None, (2280823, 65), (2280888, 82), None, None, (2280970, 42), None, None, None, (2281012, 21), None, None, None, None, None, (2281033, 42), (2281075, 21), (2281096, 21), None, (2281117, 42), (2281159, 25), None, (2281184, 16), (2281200, 21), (2281221, 56), None, None, (2281277, 21), (2281298, 19), (2281317, 26), None, (2281343, 16), None, (2281359, 21), None, None, (2281380, 38), None, (2281418, 22), (2281440, 21), (2281461, 21), (2281482, 21), None, (2281503, 63), None, (2281566, 21), (2281587, 42), None, (2281629, 17), None, None, None, None, (2281646, 21), (2281667, 21), None, None, (2281688, 21), None, None, (2281709, 21), None, (2281730, 26), None, (2281756, 50), None, None, None, (2281806, 50), (2281856, 26), (2281882, 21), (2281903, 21), (2281924, 19), None, (2281943, 35), (2281978, 26), (2282004, 23), (2282027, 39), (2282066, 42), None, None, None, None, None, None, (2282108, 21), None, None, None, (2282129, 21), None, None, (2282150, 90), None, (2282240, 239), (2282479, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
